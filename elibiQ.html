<!DOCTYPE html>
<html>
<head>
    <title>FASTQ Processor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>ElibiQ Quality Trimmer</h1>
    <input type="file" id="fileInput" accept=".fastq">
    <button onclick="processFile()">Trim and Download</button>
    <a id="downloadLink" style="display: none;">Download Trimmed FASTQ</a>

    <script>
        function processFile() {
            const fileInput = document.getElementById('fileInput');
            const downloadLink = document.getElementById('downloadLink');

            if (fileInput.files.length === 0) {
                alert('Please select a FASTQ file.');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(event) {
                const content = event.target.result;
                const trimmedContent = trimLowQuality(content);
                const trimmedFile = new Blob([trimmedContent], { type: 'text/plain' });
                const trimmedFileURL = URL.createObjectURL(trimmedFile);

                downloadLink.href = trimmedFileURL;
                downloadLink.download = 'trimmed.fastq';
                downloadLink.style.display = 'block';
            };

            reader.readAsText(file);
        }

        function trimLowQuality(fileContent) {
            const lines = fileContent.trim().split('\n');
            var trimmedLines = [];
            for (let i = 0; i < lines.length; i += 4) {
                const trim_data = trimLowQualitySequence(lines[i], lines[i + 1], lines[i + 3])
                const trimmedSequence_list = trim_data[0];
                const trim_qual_list = trim_data[1]
                if (trimmedSequence_list.length > 0) {
                    for (let j = 0; j < trimmedSequence_list.length; j++) {
                    trimmedLines.push(lines[i], trimmedSequence_list[j], '+', trim_qual_list[j]);
                }
            }
            }
            return trimmedLines.join('\n');         
        }   

        function trimLowQualitySequence(read_id, sequence, quality) {
            const threshold = 10; // Adjust this threshold as needed
            const min_length = 50;
            var trimmedSequence_list = [];
            var trim_qual_list = []; 
            var trim_seq = ''
            var trim_qual = '' 
            for (let i = 0; i < quality.length; i++) {
                   if (quality.charCodeAt(i) - 33 >= threshold) {
                    trim_seq += sequence[i];
                    trim_qual += quality[i];
                    }
                    else if (trim_seq.length > min_length){
                        trimmedSequence_list.push(trim_seq)
                        trim_qual_list.push(trim_qual)
                        trim_seq = ''
                        trim_qual = '' 
                    }
            }
            return [trimmedSequence_list, trim_qual_list]
        }
    </script>
</body>
</html>