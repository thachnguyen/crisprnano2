<html>
    <head>
    <style>
        h1{
        color:rgba(2, 3, 88, 0.932);
        padding:0;
        font-family:Baskerville, "Palatino Linotype", Palatino, "Century Schoolbook L", "Arial", sans-serif;
        font-size:30px;
        }
        .column {
        float: left;
        width: 50%;
        }
        .input_form {
        border-radius: 6px;
        border: 2px solid #0c0c0c;
        }
        .top_menu {
        border-radius: 10px;
        border: 2px solid #0c0c0c;
        }
        .button {
        background-color: #7dbfe0; 
        border: 2px solid #0c0c0c;
        border-radius: 10px;
        color: rgb(8, 8, 8);
        padding: 10px 22px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 12px;
        margin: 4px 2px;
        cursor: pointer;
        }

        /* Popup container - can be anything you want */
.popup {
  position: relative;
  display: inline-block;
  cursor: pointer;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.hidden {
      display: none;
    }
.text-right {
            text-align: right;
        }

/* The actual popup */
.popup .popuptext {
  visibility: hidden;
  width: 460px;
  background-color: rgb(173, 211, 201);
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 8px 0;
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  margin-left: -80px;
}

/* Popup arrow */
.popup .popuptext::after {
  content: "";
  position: absolute;
  top: 100%;
  left: 50%;
  margin-left: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: #b3acac transparent transparent transparent;
}

/* Toggle this class - hide and show the popup */
.popup .show {
  visibility: visible;
  -webkit-animation: fadeIn 1s;
  animation: fadeIn 1s;
}

/* Add animation (fade in the popup) */
@-webkit-keyframes fadeIn {
  from {opacity: 0;} 
  to {opacity: 1;}
}

@keyframes fadeIn {
  from {opacity: 0;}
  to {opacity:1 ;}
}

    .box {
            width: 30%; /* Adjust as needed to leave space for margin/padding */
            float: left;
            margin-right: 1%; /* Adjust margin between boxes */
            /* border: 1px solid black; Optional: Add border for visual separation */
            /* box-sizing: border-box; Include border and padding in width */
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.0/xlsx.full.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>CRISPRnano2</title>

        <!-- Bootstrap core CSS -->
        <link href="./crisprnano2/bootstrap.min.css" rel="stylesheet" type="text/css">

        <!-- Custom fonts for this template-->
        <link href="./crisprnano2/all.min.css" rel="stylesheet" type="text/css">

        <!-- Page level plugin CSS-->
        <link href="./crisprnano2/dataTables.bootstrap4.css" rel="stylesheet">

        <!-- Custom styles for this template -->
        <link href="./crisprnano2/stylesBase.css" rel="stylesheet">
        <link href="./crisprnano2/myStyles.css" rel="stylesheet">

         <!-- To multiselect -->
        <link rel="stylesheet" href="./crisprnano2/bootstrap-multiselect.css" type="text/css">

        <!-- Select with search -->
        <link rel="stylesheet" href="./crisprnano2/bootstrap-select.min.css" type="text/css">

        <!-- Intro js -->
        <link rel="stylesheet" href="./crisprnano2/introjs.css" type="text/css">
        <link href="./crisprnano2/stylesQuery.css" rel="stylesheet">

        </head>
        <body data-new-gr-c-s-check-loaded="14.1130.0" data-gr-ext-installed="">
            <nav class="navbar sticky-top navbar-expand-sm navbar-light">
                <a class="navbar-brand" href="https://www.crisprnano.de/CRISPRnano2.html"><img src="./crisprnano2/title_white.png" width="180"></a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggler11" aria-controls="navbarToggler11" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarToggler11">
                    <ul class="navbar-nav  ml-auto">
                        <li class="nav-item mt-1">
                            <a href="https://www.crisprnano.de/CRISPRnano2.html" class="nav-link">
                                <i class="fas fa-solid fa-user iconsMenu"></i>
                                Home
                            </a>
                        </li>
                        <li class="nav-item mt-1", onclick="TabClicked(2);">
                            <a  class="nav-link">
                                <i class="fas fa-solid fa-cogs iconsMenu"></i>
                                Use Crisprnano v2           
                            </a>
                        </li>
                        <li class="nav-item ml-2 mr-2 mt-1",  onclick="TabClicked(2);">
                            <a class="nav-link">
                                <i class="fas fa-solid fa-pen iconsMenu"></i>
                                How to cite
                            </a>
                        </li>
                        <li class="nav-item ml-2 mr-2 mt-1 " onclick="TabClicked(3)">
                            <a class="nav-link">
                                <i class="fas fa-solid fa-question iconsMenu"></i>
                                About
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
            <div class="d-flex justify-content-center mt-3">
                <img id="titleIndex" width="20%" src="./crisprnano2/titleBig.png">
            </div>
        <hr>
        <div class="row">
            <div class="col-md-11" style="float:none;margin:auto;">
                <div class="card">
                    <br>
        <div id="DIV_topmenu">
            <div class="text-center">
                <div class="btn-group btn-group-lg mr-3" role="group" id="aBtnGroup" aria-label="Basic example">
                    <button type="button"  name="setup" class="btn btn-info" onclick="TabClicked(0);">ANALYZER SETTING</button>
                    <div id="save" style="display:none">test</div>
                    <button type="button"  name="result" class="btn btn-info" onclick="TabClicked(1);">RESULTS</button>
                    <button type="button"  name="bulkview_result" class="btn btn-info" onclick="TabClicked(4);">BULK/SINGLE CLONE VIEWER</button>
                    <button type="button"  name="offtarget_result" class="btn btn-info" onclick="TabClicked(5);">OFF-TARGET ANALYSIS</button>
                    <button type="button"  name="result" class="btn btn-info" onclick="TabClicked(6);">TEST DATA</button>
                </div>
            </div>
        </div>
        <br>
        <div id="setup" style="position:absolute; left:20px; top:80px">


                <div class="column">
                    <br>
                    <br>


                        <h5><a href="https://github.com/thachnguyen/CRISPRnano">Manual</a></h5>
                        <h5><a href="https://github.com/thachnguyen/CRISPRnano" target="_top">Source code on Github</a></h5>
                        
                            <h3 id='optional_para'>Optional parameters</h3>
                            <small class="text-muted">Click to expand</small>
                            <div id = "optional_para_Container" class="hidden">
                            Sequence (if genename given, leave it blank):                 
                            <div class="popup" onclick="myFunction3()">(? Click here!)
                                <span class="popuptext" id="help3">Reference amplicon length should be in the range of 200-300 bases with the nuclease target site located roughly in the middle. You can get the reference from Ensembl link below. Click again to close</span>
                            </div>
                            <br><input type="text" class="input_form" size="30" id="locus" name="Locus" value=""> 
                            <br>
                            <br>             
                            <!-- <a href="http://ftp.ensembl.org/pub/release-105/fasta/homo_sapiens/dna/">(Ensembl reference)</a><br> -->
                            <!-- Sequencing method:                 
                            <div class="popup" onclick="myFunction3()">(? Click here!)
                                <span class="popuptext" id="help3">Reference amplicon length should be in the range of 200-300 bases with the nuclease target site located roughly in the middle. You can get the reference from Ensembl link below. Click again to close</span>
                            </div>
                            <select id="seq_method" name="seq_method">
                                <option value="ONT">Nanopore</option>
                                <option value="Il_pac">Illumina or PacBio</option>
                              </select> -->
                            <!-- <br>  <br>  -->
                            
                                Interested region (optional) +/- bp: 
                                <div class="popup" onclick="myFunction5()">(? Click here!)
                                    <span class="popuptext" id="help5"> For ONT reads, it is recommended to use -/+15 bases around the predicted DNA lesion. Larger regions are prone to false positive indels. Larger regions (total of 200-250 bp) can be safely used with Illumina reads. You can drag and drop the central point of the predicted double strand break in the genomic sequence to the left or to the right. Default value 0 is double strand breaking point- Crisprnano will use the first index of sgRNA mapped on reference. Click again to close</span>
                                </div>
                                <br><input type="text" size="30" name="region_analyse" value="45" class="input_form" onchange="checkValue();"><br>
        
                                <br>Indel Threshold [%]: 
                                <div class="popup" onclick="myFunction9()">(? Click here!)
                                    <span class="popuptext" id="help9">The Indel Threshold determines at what relative occurrence an individual indel mutation is considered as a unique allele of the respective clone analyzed, and is thus displayed in the alignment list. Low threshold values can result in false positive allele calling due to sequencing errors, whereas high threshold values result in false negative allele calling. Values in between 0 - 100 % can be entered. We recommend to use 5% for ONT reads and 2% for Illumina reads (default is set to 5%). Click again to close.</span>
                                </div> 
                                <br><input type="text" size="30" class="input_form" id= "allelethreshold" name="MutationThreshold" value="2" onchange="checkValue();"><br>
                                <br>PHred Threshold: 
                                <div class="popup" onclick="myFunction10()">(? Click here!)
                                    <span class="popuptext" id="help10">The Quality threshold determine the minimum filter base, For Illumina it should be >20, For ONT it should be >10, Click again to close.</span>
                                </div> 
                                <br><input type="text" size="30" class="input_form" id = "phredthreshold" name="Phred" value="20" onchange="checkValue();"><br>
                                <br>dsDNA without Homology Arm 
                                <div class="popup" onclick="myFunction10()">(? Click here!)
                                    <span class="popuptext" id="help10">The Quality threshold determine the minimum filter base, For Illumina it should be >20, For ONT it should be >10, Click again to close.</span>
                                </div> 
                                <br><input type="text" size="30" class="input_form" id = "dsDNA_KI" name="dsDNA_KI" ><br>

                                <br>ssDNA with Homology Arm 
                                <div class="popup" onclick="myFunction10()">(? Click here!)
                                    <span class="popuptext" id="help10">The Quality threshold determine the minimum filter base, For Illumina it should be >20, For ONT it should be >10, Click again to close.</span>
                                </div> 
                                <br><input type="text" size="30" class="input_form" id = "ssDNA_KI" name="dsDNA_KI" ><br>

                            </div>
                            <p></p>
        
                            <br> <br><br>                <br>
                            <br>
                            <br>
                          


                </div>
                <br>
                <div class="column">
                <h3>Input data</h3>    
                FASTQ Files (*): 
                <div class="popup" onclick="myFunction1()">(? Click here!)
                    <span class="popuptext" id="help1">FASTQ output files from Illumina or ONT. We recommend file's size smaller than 200MB. Make sure that the correct ordering is applied in the file browser. The file allocation to individual pie charts can be verified by the numbers given at alignment track. Click again to close.</span>
                </div>
                    <br><input type="file" id="files" class="input_form" name="files[]" multiple=""><br>
                    <br>
                    <label>Data type:</label>
                    <select id="mySelect" onchange="setValue()">
                        <option value="illu">Illumina</option>
                        <option value="ont">Nanopore</option>
                        <option value="pacbio">PacBio or Nanopore Duplex</option>
                    </select>
                    <br>
                    <small class="text-muted">Window size & indel rate will automatically adjusted</small>
                    <br>
                    <br>Gene Name (**):
                    <div class="popup" onclick="myFunction8()">(? Click here!)
                        <span class="popuptext" id="help8">Name of the study gene (Human only). Click to close.</span>
                    </div>
                    <br>
                    <input type="text" class="input_form" size="40" name="GeneName" value="" onchange="getFastaSequence()"><br>
                    <small class="text-muted">Gene names are from <a href="https://crisprnano.de/genename.txt">this list</a></small><br>
                    <br>Nuclease Target Site (*): 
                    <div class="popup" onclick="myFunction4()">(? Click here!)
                        <span class="popuptext" id="help4">In this field the nuclease target site is entered. The sequence has to be in the same orientation as the reference sequence above. Click again to close</span>
                    </div>
                    <br><input type="text" class="input_form" size="40" name="RightBS" value="CATTTGCTGGAGGTCACCCA"><br>
                    <br>Targeting mutagenesis oligonucleotide (Knock-in): 
                    <div class="popup" onclick="myFunction7()">(? Click here!)
                        <span class="popuptext" id="help7">Donor oligonucleotide sequence used to introduce a site specific genomic modification. The sequence entered should be in the same orientation as the amplicon sequence. Click again to close.</span>
                    </div>
                    <br><input type="text" class="input_form" size="40" name="TargetingOligo" value=""><br>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="prime_editing">
                        <label class="form-check-label">
                          Prime Editing/Knockin-only mode (exclude INDEL)
                        </label>
                      </div>
                    <br>
                    <input type="submit" name="submit" value="SUBMIT  " class="btn btn-primary btn-lg" id="submit" onclick="Start();">
                    <div id="progress" style="display:none; padding: 10px; border: 10px solid #CCC; background: #EEE; width:60%; position:absolute; top:50%;left:40%">
                    </div>
                    <br>
                </div>
                
                <!-- <a href="https://iufduesseldorf-my.sharepoint.com/:u:/g/personal/thach_nguyen_iuf-duesseldorf_de/ER4kM3RQaRJLiltUCpcT2iMBiEvGvs3u2NiDTdtSPBLE1Q?e=8FEAJc">(Our test sample)</a><br> -->
 
                <br>
                <br>
                <br>
                <br>                    <br>
                <br>                    <br>
                <br>                    <br>
                <br>
                <br>
                <br>                    <br>
                <br>                    <br>
                <br>                    <br>
                <br>                    <br>
                <br>                    <br>
                <br>
                
                <a style="font-style: italic;">
                    CRISPRnano website is free and open to all users and there is no login required.<br>
                    To use CRISPRnano, you must enable JavaScript on your web browser.<br>
                    If you want to use CRISPRnano offline, please download </a><a href="https://iufduesseldorf-my.sharepoint.com/:u:/g/personal/thach_nguyen_iuf-duesseldorf_de/EeZRZlyFP31Gu-s-w57wlfEB42anCiwxbXRms_U_GAekpQ?e=YxlI2v"> the offline html file here.</a> <br>
                    <br>
                <a style="font-style: italic;"> (*) Mandatory field 
                <br>
                <a style="font-style: italic;"> (**) If Gene name is blank, customer sequence must given 
                    <br>
                    <br>
                <br>
                Reference: <br>
                Nguyen, T., Ramachandran, H., Martins, S., Krutmann, J. and Rossi, A., 2022. Identification of genome edited cells using CRISPRnano. Nucleic Acids Research.<br></a>
                <br><br>
                <br>
                Question: thach.nguyen**(replace with email symbol)**iuf-duesseldorf.de
            </div>
        
            <div id="about" style="position: absolute; left: 20px; top: 120px; width: 70%; display: none;">
                <br>
                <br>
                <b>About:</b>
                <br>
                <br>CRISPRnano is a javascript-based program that was developed for rapid deep sequencing based genotyping of nuclease edited cell clones.  
                CRISPRnano supports noisy Oxford Nanopore but also Next Generation Sequencing (NGS) reads such as Illumina and PacBio or Sanger Sequencing. <br> <br>
                CRISPRnano was developed by Dr. Thach Nguyen in the group of Dr. Andrea Rossi (GEMD lab) at Leibniz Research Institute for Environmental Medicine. The template web interface, data input, output are developed based on the template of Outknocker http://www.outknocker.org/. 
                <br>
                <br>
                <br><b>Licence:</b>
                <br>
                <br>CRISPRnano can be redistributed and/or modified under the terms of the GNU General Public License (Version 2), as published by the Free Software Foundation. A copy of the license can be found online at www.gnu.org/licenses. CRISPRnano is distributed in the hope that it will be useful, but without any warranty; without even the implied warranty of merchantability or fitness for a particular purpose. See the GNU General Public License for more details.                <br>
                <br><b>Citing CRISPRnano:</b>
                <br>
                <br>
                <br>We kindly request that use of this software be cited in publications as:<br>
                Nguyen, T., Ramachandran, H., Martins, S., Krutmann, J. and Rossi, A., 2022. Identification of genome edited cells using CRISPRnano. Nucleic Acids Research. 
                <br>   
              <br><br>
            </div>

            <div id="manual" style="position: absolute; left: 20px; top: 120px; width: 70%; display: none;">
                <br>
                <br>
                <h3>CRISPRnano manual</h3>
                CRISPRnano is a javascript-based program that was developed for rapid deep sequencing based genotyping of nuclease edited cell clones. CRISPRnano supports noisy Oxford Nanopore but also Next Generation Sequencing (NGS) reads such as Illumina, PacBio, or classic Sanger Sequencing.<br><br>
                <b>Input data:</b>
                <br>
                <br>CRISPRnano analyzes FASTQ output files from ONT, NGS, or Sanger systems.
                CRISPRnano webserver analyzes multiple samples and supports up to 96 FASTQ files at the time.
                We recommend a file's size smaller than 200MB. Please, make sure that the correct ordering is applied in the file browser.
                The file allocation to individual pie charts can be verified by the numbers given at alignment track.
                Our data contains multiple small FASTQ files.  FASTQ files can be concatenated using command <b>cat</b> under Linux or <b>type</b> under Windows environment.<br>
                On Linux terminal:<br>
                $ cat /path/to/fastq/files/*.fastq &gt; /your/new/location/output.fastq<br><br>
                On Window command prompt (path symbol is different):<br>
                $ type \path\to\fastq\files\*.fastq&gt; \your\new\location\output.fastq<br>
                
                <br>
                <b>Reference sequences</b> 
                <br>
                Reference amplicon length should be in the range of 200-350 bases (based on your library preparation), with the nuclease target site located roughly in the middle. The reference sequence of your gene of interest can be retrieved from <a href="http://ftp.ensembl.org/pub/release-105/fasta/homo_sapiens/dna/"> Ensembl database</a>. <br><br>

                <b>Nuclease Target Site</b> 
                <br>
                The Nuclease Target Site sequence (CRISPR, TALEN, ZINC-Finger, etc.) has to be in the same orientation as the reference sequence above. The Nuclease Target Site is briefly checked if it is contained in Reference genome<br><br>
                
                <b>Interested region and Offset centre</b> 
                <br>
                For ONT reads, it is recommended to use -/+15 bases around the predicted DNA lesion. Larger regions are prone to false positive indels. 
                Larger regions (total of 200-250 bp) can be safely used with Illumina reads. You can drag and drop the central point of the predicted double strand break in the genomic sequence to the left or to the right. Default 0 is double strand breaking point.<br><br>
                
                <b>Targeting mutagenesis oligonucleotide</b> 
                <br>
                Donor oligonucleotide sequence is used to introduce a site specific genomic modification. 
                The sequence entered should be in the same orientation as the amplicon sequence. <br><br>
                <b>Indel Threshold</b> 
                <br>
                The Indel Threshold percentage determines at what relative occurrence an individual indel mutation is considered as a unique allele of the respective clone analyzed, and is thus displayed in the alignment list. 
                Low threshold values can result in false positive allele calling due to sequencing errors, 
                whereas high threshold values result in false negative allele calling. Values in between 0 - 100 % can be entered. We recommend using 5% for ONT reads and 2% for Illumina reads (the default is set to 5%).  <br><br>
                
                <b>Code Availability </b> 
                <br>
                The source code for CRISPRnano is available at <a href="https://github.com/thachnguyen/CRISPRnano">https://github.com/thachnguyen/CRISPRnano</a> <br><br>
                
                <b>Test data </b> 
                <br>
                The test data for CRISPRnano is available at <a href="https://iufduesseldorf-my.sharepoint.com/:u:/g/personal/thach_nguyen_iuf-duesseldorf_de/ER4kM3RQaRJLiltUCpcT2iMBiEvGvs3u2NiDTdtSPBLE1Q?e=8FEAJc">our test sample.</a><br><br>
                <b>
                    Browser compatibility
                </b>
                <table style="width:100%">
                    <tbody><tr>
                        <td>OS</td>
                        <td>Version</td>
                        <td>Chrome</td>
                        <td>Firefox</td>
                        <td>Microsoft Edge</td>
                        <td>Safari</td>
                    </tr>
                    <tr>
                        <td>Linux</td>
                        <td>Ubuntu 20.04</td>
                        <td>Version 122.0.6261.128</td>
                        <td>125.0</td>
                        <td>n/a</td>
                        <td>n/a</td>
                    </tr>
                    <tr>
                        <td>MacOS</td>
                        <td>Monterey</td>
                        <td>Version 122.0.6261.128</td>
                        <td>125.0</td>
                        <td>n/a</td>
                        <td>15.3 </td>
                    </tr>
                    <tr>
                        <td>Windows</td>
                        <td>10</td>
                        <td>Version 122.0.6261.128</td>
                        <td>98.0</td>
                        <td>122.0.6261.128</td>
                        <td>n/a</td>
                    </tr>
                  </tbody></table>
                
            </div>

            <div id="testdata" style="position: absolute; left: 20px; top: 120px; width: 70%; display: none;">
                <br>
                <br>
                <h3>TEST DATA</h3>
                
                <b>Code Availability </b> 
                <br>
                The source code for CRISPRnano is available at <a href="https://github.com/thachnguyen/CRISPRnano">https://github.com/thachnguyen/CRISPRnano</a> <br><br>
                
                <b>Test data </b> 
                <br>
                The test data for CRISPRnano is available at <a href="https://iufduesseldorf-my.sharepoint.com/:u:/g/personal/thach_nguyen_iuf-duesseldorf_de/ER4kM3RQaRJLiltUCpcT2iMBiEvGvs3u2NiDTdtSPBLE1Q?e=8FEAJc">our test sample.</a><br><br>
                <b>
                    Browser compatibility
                </b>
                <table style="width:100%">
                    <tbody><tr>
                        <td>OS</td>
                        <td>Version</td>
                        <td>Chrome</td>
                        <td>Firefox</td>
                        <td>Microsoft Edge</td>
                        <td>Safari</td>
                    </tr>
                    <tr>
                        <td>Linux</td>
                        <td>Ubuntu 20.04</td>
                        <td>Version 99.0.4844.51</td>
                        <td>98.0</td>
                        <td>n/a</td>
                        <td>n/a</td>
                    </tr>
                    <tr>
                        <td>MacOS</td>
                        <td>Monterey</td>
                        <td>Version 99.0.4844.51</td>
                        <td>98.0</td>
                        <td>n/a</td>
                        <td>15.3 </td>
                    </tr>
                    <tr>
                        <td>Windows</td>
                        <td>10</td>
                        <td>Version 99.0.4844.51</td>
                        <td>98.0</td>
                        <td>99.0.115039</td>
                        <td>n/a</td>
                    </tr>
                  </tbody></table>
                
            </div>

            <div id="results" style="position: absolute; left: 20px; top: 160px; display: none;">
                <div class="column">
                    <div id="DIV_piecharts">
                        <svg id="SVGpie" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="900" height="520">
                        </svg>
                    </div>
                    <div id="DIV_alignment">
                        <svg id="SVGmut" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1600" height="5000">
                        </svg>
                    </div>

                </div>
                <div class="column" style="position: absolute; left: 900px; top: 60px">
                    <h3>SECONDARY ANALYSIS</h3> 
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="bulkview">
                        <label class="form-check-label" for="bulkview">SWITCH TO BULK/SINGLE CLONE VIEW </label>
                      </div>
                      <small class="text-muted">NOTE: Click to the sample after selecting above option. Bulk view use lower percentage threshold</small>
                      <br>
                      <br>
                    <h4>OFF TARGET Analysis (optional)</h4>    
                        List of off-target Gene names (separate by ,):
                        <div class="popup" onclick="myFunction8()">(? Click here!)
                            <span class="popuptext" id="help8">Name of the study genes, seperate by , . Click to close.</span>
                        </div>
                        <br>
                        
                        <input type="text" class="input_form" size="40" name="GeneName_list" id="GeneName_list" value="" onchange="checkOccurrence(); getFastaSequence_list();"><br>
                        <small class="text-muted">Off-target analysis will check up to 4 genes in a single run</small>
                        <br>
                        <button id="toggleButton">List of offset sgRNA:</button>
                        <br>
                        <small class="text-muted">If off-target sgRNA empty, system will take the previous sgRNA to find region of interest</small>
                        <br>
                        <div id="sgRNAContainer" class="hidden">
                        <br>
                        <small class="text-muted">sgRNA gene 1</small>
                        <input type="text" class="input_form" size="40" name="sgRNA1" id="sgRNA1" value="" ><br>
                        <br>
                        <small class="text-muted">sgRNA gene 2</small>
                        <input type="text" class="input_form" size="40" name="sgRNA2" id="sgRNA2" value=""><br>
                        <br>
                        <small class="text-muted">sgRNA gene 3</small>
                        <input type="text" class="input_form" size="40" name="sgRNA3" id="sgRNA3" value=""><br>
                        <br>
                        <small class="text-muted">sgRNA gene 4</small>
                        <input type="text" class="input_form" size="40" name="sgRNA4" id="sgRNA4" value=""><br>
                        <br>
                        </div>
                        <br>

                        <input type="submit" name="submit" value="START OFFTARGET ANALYZER " class="btn btn-primary btn-sm" id="submit" onclick="Start2();">
                        <br>
                        <br>
                        <div class="text-right">
                        <h4>Save data</h4> 
                        <button class="btn btn-secondary btn-sm" onclick="SaveProject();"> SAVE HTLM File (.html)</button> 
                        <br>
                        <br>
                        <button class="btn btn-secondary btn-sm" onclick="SaveReport();">Indel report Excel .XLSX</button>
                        <br>
                        <br>
                        <button class="btn btn-secondary btn-sm" onclick="SaveReportcsv();">Indel report CSV .csv</button>
                        <br> 
                        <br>
                        <button class="btn btn-secondary btn-sm" onclick="SaveSVGAlignment();">Save alignment (.svg)</button> 
                        <br>
                        <br>
                        <button class="btn btn-secondary btn-sm" onclick="PrintSVG();">Print pie charts (.pdf)</button> 
                        </div>
                        <div id="progress1" style="display:none; padding: 10px; border: 10px solid #CCC; background: #EEE; width:80%; position:absolute; top:40%;left:0%">
                        </div>
                            <br>
                    </div>

                <div style="position:absolute; right:10%; top:0%" id="restart" align="right">

                </div> 
            </div>

            <div id="bulkview_result" style="position: absolute; left: 20px; top: 160px; display: none;">
                <div id="DIV_piecharts_bulk" >
                    <div>
                    <div class="box">
                        <svg id="SVGpie_bulk" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="400" height="300"></svg>
                    </div>
                    <div id="Indel_plot" class = "box" style="width: 400px; height: 300px;">
                    </div>
                    </div>
                    <div>
                    <div id="QC_plot" class = "box" style="width: 400px; height: 300px;"></div>
                    <div id="read_plot" class = "box" style="width: 480px; height: 300px;"></div>
                    <div id="GC_plot" class = "box" style="width: 400px; height: 300px;"></div>
                    </div>
                </div>

                <div id="DIV_alignment_bulk" >
                    <svg id="SVGmut_bulk" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1600" height="5000">
                    </svg>
                </div>
            </div>

            <div id="offtarget_view" style="position: absolute; left: 20px; top: 160px; display: none;">
                <div class="column">
                    <div id="DIV_piecharts_off">
                        <svg id="SVGpie_off" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1600" height="420">
                        </svg>
                    </div>
                </div>
                <div id="DIV_alignment_off">
                    <svg id="SVGmut_off" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1600" height="5000">
                    </svg>
                </div>
            </div>

</body>

<script>

//check input gene offtarget genes list
function checkOccurrence() {
    // Get the input value
    const inputValue = document.getElementById('GeneName_list').value;
    // Define the target string to check occurrence
    const targetString = ','; 
    // Count the occurrences of the target string in the input
    const occurrenceCount = (inputValue.match(new RegExp(targetString, 'gi')) || []).length;
    // Check if the occurrence count is greater than 4,
    if (occurrenceCount > 3) {
    alert(`Error: we only support maximum 4 off-target genes.`);
    }
} 

function checkValue() {
    // Get the input value
    const region_analyse1 = document.getElementsByName('region_analyse')[0].value;
    // Define the target string to check occurrence
    const MutationThreshold1 = document.getElementsByName("MutationThreshold")[0].value;
    const phred = document.getElementsByName("Phred")[0].value;

    if (MutationThreshold1*1 > 100||MutationThreshold1*1<0) {
    alert('Please check the Mutation threshold again');
    document.getElementsByName("MutationThreshold")[0].value = '2';
    }
    if (phred*1 > 60||phred*1<5) {
    alert('Please check this value again, Phred should be in range 5 to 60');
    document.getElementsByName("Phred")[0].value = '10';
    }
    if (region_analyse1*1 > 70||region_analyse1*1<30) {
    alert('System only support region area from 30-70 bp');
    document.getElementsByName('region_analyse')[0].value = "40";
    } 
}

function setValue() {
    // Get the input value
    // Define the target string to check occurrence

    var mySelect = document.getElementById('mySelect');
    if (mySelect.value == 'ont'){
        document.getElementsByName('region_analyse')[0].value = "40";
        document.getElementsByName("MutationThreshold")[0].value = '5'
        document.getElementsByName("Phred")[0].value = '10'
    }
    else {
        document.getElementsByName('region_analyse')[0].value = "45";
        document.getElementsByName("MutationThreshold")[0].value = '2'
        document.getElementsByName("Phred")[0].value = '20'
    } 
}

//Drag and interactive

var AlignmentDragging = false, AlignmentLastX, AlignmentLastY, AlignmentStartPos = 0;

function AlignmentMouseDown(evt)
{
    AlignmentLastX = evt.clientX;
    AlignmentLastY = evt.clientY;
    AlignmentDragging = true;
    return false;
}
function AlignmentMouseMove(evt)
{
    if (AlignmentDragging)
    {
        var x = evt.clientX;
        var y = evt.clientY;
        //alert(x-AlignmentLastX);
        var shift = (x-AlignmentLastX)/12;
        AlignmentStartPos -= shift;
        if (AlignmentStartPos < -2*region_analyse) AlignmentStartPos = -2*region_analyse;
        if (AlignmentStartPos > 2*region_analyse) AlignmentStartPos = 2*region_analyse;
        PlotAlignment(CurrentAlignment, locus);

        AlignmentLastX = x;
    }
    return false;
}

function AlignmentMouseMove_bulk(evt)
{
    if (AlignmentDragging)
    {
        var x = evt.clientX;
        var y = evt.clientY;

        //alert(x-AlignmentLastX);
        var shift = (x-AlignmentLastX)/12;
        AlignmentStartPos -= shift;
        if (AlignmentStartPos < -region_analyse) AlignmentStartPos = -region_analyse;
        if (AlignmentStartPos > region_analyse+10) AlignmentStartPos = region_analyse+10;
        PlotAlignment_bulk(CurrentAlignment, locus, bulk_threshold);
        AlignmentLastX = x;
    }
    return false;
}

function AlignmentMouseMove_off(evt)
{
    if (AlignmentDragging)
    {
        var x = evt.clientX;
        var y = evt.clientY;

        //alert(x-AlignmentLastX);
        var shift = (x-AlignmentLastX)/12;
        AlignmentStartPos -= shift;
        if (AlignmentStartPos < -region_analyse) AlignmentStartPos = -region_analyse;
        if (AlignmentStartPos > region_analyse+10) AlignmentStartPos = region_analyse+10;
        PlotAlignment_off(CurrentAlignment_off);
        AlignmentLastX = x;
    }
    return false;
}


function AlignmentMouseUp(evt) {
    AlignmentDragging = false;
    return false;
}

// Alignment algorithms
// modified version of Smith Watermann algorithm using adaptive aligning
// This program use some API from implementation by Prof Heng Li at https://github.com/lh3/bioseq-js
/**
 * Encode a sequence string with table
 * @param seq    sequence
 * @param table  encoding table; must be of size 256
 *
 * @return an integer array
 */
// get fasta from our database

function bsg_enc_seq(seq, table){
    if (table == null) return null;
    var s = [];
    s.length = seq.length;
    for (var i = 0; i < seq.length; ++i)
        s[i] = table[seq.charCodeAt(i)];
    return s;
}

/**
 * Generate scoring matrix from match/mismatch score
 *
 * @param n     size of the alphabet
 * @param a     match score, positive
 * @param b     mismatch score, negative
 *
 * @return sqaure scoring matrix. The last row and column are zero, for
 * matching an ambiguous residue.
 */
function bsa_gen_score_matrix(n, a, b){
    var m = [];
    if (b > 0) b = -b; // mismatch score b should be non-positive
    for (var i = 0; i < n - 1; ++i) {
        m[i] = [];
        for (var j = 0; j < n - 1; ++j)
            m[i][j] = i == j? a : b;
        m[i][j] = 0;
    }
    m[n-1] = [];
    for (var j = 0; j < n; ++j) m[n-1][j] = 0;
    return m;
}

/**
 * Generate query profile (a preprocessing step)
 *
 * @param _s      sequence in string or post bsg_enc_seq()
 * @param _m      score matrix or [match,mismatch] array
 * @param table   encoding table; must be consistent with _s and _m
 *
 * @return query profile. It is a two-dimensional integer matrix.
 */
function bsa_gen_query_profile(_s, _m, table){
    var s = typeof _s == 'string'? bsg_enc_seq(_s, table) : _s;
    var qp = [], matrix;
    if (_m.length >= 2 && typeof _m[0] == 'number' && typeof _m[1] == 'number') { // match/mismatch score
        if (table == null) return null;
        var n = typeof table == 'number'? table : table[table.length-1] + 1;
        matrix = bsa_gen_score_matrix(n, _m[0], _m[1]);
    } else matrix = _m; // _m is already a matrix; FIXME: check if it is really a square matrix!
    for (var j = 0; j < matrix.length; ++j) {
        var qpj, mj = matrix[j];
        qpj = qp[j] = [];
        for (var i = 0; i < s.length; ++i)
            qpj[i] = mj[s[i]];
    }
    return qp;
}

/**
 * Local pairwise alignemnt

    * @param target    target string
    * @param query     query string or query profile
    * @param matrix    square score matrix or [match,mismatch] array
    * @param gapsc     [gap_open,gap_ext] array; k-length gap costs gap_open+gap_ext*k
    * @param w         bandwidth, disabled by default
    * @param table     encoding table. It defaults to bst_nt5.
    *
    * @return [score,target_start,cigar]. cigar is encoded in the BAM way, where
    * higher 28 bits keeps the length and lower 4 bits the operation in order of
    * "MIDNSH".
    */
function bsa_align(target, query, matrix, gapsc){
    // convert bases to integers
    var is_local = true
    var t = bsg_enc_seq(target, bst_nt5);
    var qp = bsa_gen_query_profile(query, matrix, bst_nt5);
    var qlen = qp[0].length;
    // adjust band width
    var max_len = qlen > t.length? qlen : t.length;
    var w = true;
    var len_diff = t.target > qlen? t.target - qlen : qlen - t.target;
    w = w > len_diff? w : len_diff;
    
    // set gap score
    var gapo, gape; // these are penalties which should be non-negative
    if (typeof gapsc == 'number') gapo = 0, gape = gapsc > 0? gapsc : -gapsc;
    else gapo = gapsc[0] > 0? gapsc[0] : -gapsc[0], gape = gapsc[1] > 0? gapsc[1] : -gapsc[1];
    var gapoe = gapo + gape; // penalty for opening the first gap

    // initial values
    var NEG_INF = -0x40000000;
    
    var H = [], E = [], z = [], score, max = 0, end_i = -1, end_j = -1;
    if (is_local) {
        for (var j = 0; j <= qlen; ++j) H[j] = E[j] = 0;
    } 

    // the DP loop
    for (var i = 0; i < t.length; ++i) {
        var h1 = 0, f = 0, m = 0, mj = -1;
        var zi, qpi = qp[t[i]];
        zi = z[i] = [];
        var beg = i > w? i - w : 0;
        var end = i + w + 1 < qlen? i + w + 1 : qlen; // only loop through [beg,end) of the query sequence

        for (var j = beg; j < end; ++j) {
            // At the beginning of the loop: h=H[j]=H(i-1,j-1), e=E[j]=E(i,j), f=F(i,j) and h1=H(i,j-1)
            // If we only want to compute the max score, delete all lines involving direction "d".
            var e = E[j], h = H[j], d;
            H[j] = h1;           // set H(i,j-1) for the next row
            h += qpi[j];         // h = H(i-1,j-1) + S(i,j)
            d = h >= e? 0 : 1;
            h = h >= e? h : e;
            d = h >= f? d : 2;
            h = h >= f? h : f;    // h = H(i,j) = max{H(i-1,j-1)+S(i,j), E(i,j), F(i,j)}
            d = !is_local || h > 0? d : 1<<6;
            h1 = h;              // save H(i,j) to h1 for the next column
            mj = m > h? mj : j;
            m = Math.max(m, h);    // update the max score in this row
            h -= gapoe;
            h = !is_local || h > 0? h : 0;
            e -= gape;
            d |= e > h? 1<<2 : 0;
            e = e > h? e : h;    // e = E(i+1,j)
            E[j] = e;            // save E(i+1,j) for the next row
            f -= gape;
            d |= f > h? 2<<4 : 0;
            f = f > h? f : h;    // f = F(i,j+1)
            zi[j] = d;           // z[i,j] keeps h for the current cell and e/f for the next cell
        }
        H[end] = h1, E[end] = is_local? 0 : NEG_INF;
        if (m > max) max = m, end_i = i, end_j = mj;
    }
    if (is_local && max == 0) return null;
    score = is_local? max : H[qlen];

    // backtrack to recover the alignment/cigar
    function push_cigar(ci, op, len) {
        if (ci.length == 0 || op != (ci[ci.length-1]&0xf))
            ci.push(len<<4|op);
        else ci[ci.length-1] += len<<4;
    }
    var cigar = [], tmp, which = 0, i, k, start_i = 0;
    if (is_local) {
        i = end_i, k = end_j;
        if (end_j != qlen - 1) // then add soft cliping
            push_cigar(cigar, 4, qlen - 1 - end_j);
    } else i = t.length - 1, k = (i + w + 1 < qlen? i + w + 1 : qlen) - 1; // (i,k) points to the last cell
    while (i >= 0 && k >= 0) {
        tmp = z[i][k - (i > w? i - w : 0)];
        which = tmp >> (which << 1) & 3;
        if (which == 0 && tmp>>6) break;
        if (which == 0) which = tmp & 3;
        if (which == 0)      { push_cigar(cigar, 0, 1); --i, --k; } // match
        else if (which == 1) { push_cigar(cigar, 2, 1); --i; } // deletion
        else                 { push_cigar(cigar, 1, 1), --k; } // insertion
    }
    if (is_local) {
        if (k >= 0) push_cigar(cigar, 4, k + 1); // add soft clipping
        start_i = i + 1;
    } 
    for (var i = 0; i < cigar.length>>1; ++i) // reverse CIGAR
        tmp = cigar[i], cigar[i] = cigar[cigar.length-1-i], cigar[cigar.length-1-i] = tmp;
    return [score, start_i, cigar];
}

// generate cigar to gap in breakpoint windows, bkp11, bkp22 is offset interest region of ref wrt gap add-in ref 
function bsa_cigar2gaps_breakpoint(target, query, start, cigar, bkp1, bkp2){
    var oq = '', ot = '', oq1 = '', lq = 0, lt = start;
    var bkp11 = bkp1;
    var bkp22 = bkp2;
    var aln_type = 0;
    var gap_len = 0;
    for (var k = 0; k < cigar.length; ++k) {
        var op = cigar[k]&0xf, len = cigar[k]>>4;
        //var len1 = Math.floor(len/3)
        //update breakpoints only, no update aln_type
        // first check the alignment start point position
        if (start > bkp11){
            aln_type=0;
            continue;
        } 
        else if (lt + len <= bkp11){
            if (op == 0) { // match
                oq += query.substr(lq, len);
                ot += target.substr(lt, len);
                oq1 += Array(len).fill('\xa0').join('');
                lq += len, lt += len;
            } else if (op == 1) { // insertion (only update bkp11, 22 for insertion in reference sequence)
                oq1 += query.substr(lq, len);
                lq += len;
                bkp11 += len
                bkp22 += len
            } else if (op == 2) { // deletion
                oq += Array(len+1).join("-");
                ot += target.substr(lt, len);
                lt += len;
                oq1 += Array(len).fill('\xa0').join('');
            } else if (op == 4) { // soft clip
                lq += len;
            }
        }
        // update aln_type ONE time, otherwise assign 'ambigous read' 
        else if (bkp22 >= lt+len){
            if (op == 0) { // match ! ONLY UPDATE ONCE
                oq += query.substr(lq, len);
                ot += target.substr(lt, len);
                oq1 += Array(len).fill('\xa0').join('');
                lq += len, lt += len;
                if (aln_type==0){
                    aln_type = 1;
                }
            } else if ((op == 1)||(op == 2)) { // Combine indels
                gap_len = len;
                if (op == 1) {
                    oq1 += query.substr(lq, len);
                    lq += len;
                }
                else if (op == 2){
                    ot += target.substr(lt, len);
                    oq1 += Array(len).fill('\xa0').join('');
                    oq += Array(len+1).join("-");
                    lt += len;
                } 
                
                if (len%3 == 0){
                    //check previous state
                    if ((aln_type==0)||(aln_type==1)){
                        aln_type =2;
                    }
                    else {
                        // if aln_type already indel so it 's ambigious
                        aln_type = 8  // ambigous
                    }     
                }
                else{
                    if ((aln_type==0)||(aln_type==1)){
                        aln_type =3;
                    }
                    else {
                        aln_type = 8  // ambigous
                    }
                }
            } 
            else if (op == 4) { // soft clip
                lq += len;
            }
        }
        else {   // bk point cover single windows
            if (op == 0) { // match
                oq += query.substr(lq, len);
                ot += target.substr(lt, len);
                oq1 += Array(len).fill('\xa0').join('');
                lq += len, lt += len;
                if (aln_type==0){
                    aln_type = 1 //no indel
                }
            } else if ((op == 1)||(op == 2)) { // indel
                if (op == 1) {
                    oq1 += query.substr(lq, len);
                }
                else if (op == 2){
                    ot += target.substr(lt, len);
                    oq1 += Array(len).fill('\xa0').join('');
                    oq += Array(len+1).join("-");
                }  
                lq += len;
                if (len%3 == 0){
                    if (aln_type==0){
                        aln_type =2;
                        }
                } else{
                    if (aln_type==0){
                        aln_type =3;
                    }
                }
            } 
            else if (op == 4) { // soft clip
                lq += len;
            }
        }    
    }

    return [[oq.substr(bkp1-start, bkp2-bkp1), oq1.substr(bkp1-start, bkp2-bkp1)], aln_type, gap_len];
}

function TabClicked(i)
{
    if (i==0) document.getElementById("setup").style.display = "";
    else document.getElementById("setup").style.display = "none";

    if (i==1) document.getElementById("results").style.display = "";
    else document.getElementById("results").style.display = "none";

    if (i==2) document.getElementById("manual").style.display = "";
    else document.getElementById("manual").style.display = "none";

    if (i==3) document.getElementById("about").style.display = "";
    else document.getElementById("about").style.display = "none";

    if (i==4) document.getElementById("bulkview_result").style.display = "";
    else document.getElementById("bulkview_result").style.display = "none";

    if (i==5) document.getElementById("offtarget_view").style.display = "";
    else document.getElementById("offtarget_view").style.display = "none";
    if (i==6) document.getElementById("testdata").style.display = "";
    else document.getElementById("testdata").style.display = "none";

    document.getElementById("progress").style.display = "none";
    document.getElementById("progress1").style.display = "none";

    currenttab = i;
}

//reverse comp function
var ks_comp = {'A':'T','C':'G','G':'C','T':'A','M':'K','K':'M','Y':'R','R':'Y','V':'B','B':'V','H':'D','D':'H',
			   'a':'t','c':'g','g':'c','t':'a','m':'k','k':'m','y':'r','r':'y','v':'b','b':'v','h':'d','d':'h'};

function ReverseComplement(s)
{
	var i, t = '';
	for (i = 0; i < s.length; ++i) {
		var c = s.charAt(s.length - 1 - i);
		var d = ks_comp[c];
		t += d? d : c;
	}
	return t;
}


function getFastaSequence() {
    var myFastaURL;
    if (document.URL.includes('www')){
        myFastaURL = "https://www.crisprnano.de/gene_fasta/"+document.getElementsByName("GeneName")[0].value.replace(/[\s\n]+/g, '').toUpperCase()+".fa";
    }
    else {
        myFastaURL = "https://crisprnano.de/gene_fasta/"+document.getElementsByName("GeneName")[0].value.replace(/[\s\n]+/g, '').toUpperCase()+".fa";
    }
    fetch(myFastaURL)
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.text();
    })
    .then(data => {
        var lines = data.split('\n');
        var locus1 = lines.slice(1).join('');
        locus=locus1;
        if (locus!=""){
        alert('Loading given genes list successfully');
    }
    })
    .catch(error => {
    if (error.message === 'Network response was not ok') {
        alert('The provided URL is not valid or the gene name is not found. Please check your input and try again.');
        locus="";
    } 
    else {
        alert('An unexpected error occurred: ' + error.message);
        locus="";
    }
    });
}
function getFastaSequence_list() {
    locus_list =[]
    if (document.URL.includes('www')){
        prefix_url = "https://www.crisprnano.de/gene_fasta/";
    }
    else {
        prefix_url = "https://crisprnano.de/gene_fasta/";
    }

    "https://www.crisprnano.de/gene_fasta/"
    gene_list = document.getElementsByName("GeneName_list")[0].value.split(',')
    // for (let  gene_name1 of gene_list){
    for (let i = 0; i<4 && i< gene_list.length; i++){
        var gene_name1 = gene_list[i].trim()
        var myFastaURL = prefix_url+gene_name1.toUpperCase()+".fa";
        fetch(myFastaURL)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.text();
        })
        .then(data => {
            var lines = data.split('\n');
            var locus1 = lines.slice(1).join('');
            locus_list.push(locus1);
        })
        .catch(error => {
        if (error.message === 'Network response was not ok') {
            alert('The provided URL is not valid or the gene name is not found. Please check your input and try again.');
            locus_list =[];
        } 
        else {
            alert('An unexpected error occurred: ' + error.message);
            locus_list =[];
        }
    });
    }
    if (locus_list!=[]){
        alert('Loading given genes list successfully');
    }
}

function FileReceived() {
    var original = RestFromLastChunk+reader.result;
    var cursor = 0, origlen = original.length;
    // alignment parameter for affine score DP algorithms 
    var ms = 1 // match score
    var mms = -1//mismatch score
    var gapo = -4  // gap open score
    var gape = -1  // gap extent score
    var id = CurrentFileId;
    var target = locus;
    var targetingOligo = document.getElementsByName("TargetingOligo")[0].value.replace(/[\s\n]+/g, '').toUpperCase(); //TargetingOligo
    PhredThreshold = 1*document.getElementsByName("Phred")[0].value;
    var checkbox = document.getElementById('prime_editing');
    var prime_mode = document.getElementById('prime_editing').checked;
    // Add a change event listener to the checkbox

    //check target oligo in reference or reverse ref
    if (targetingOligo !=""){
            var score_oligo_ref_fw = bsa_align(locus.substring(BreakPoint-region_analyse*1, BreakPoint + region_analyse*1), targetingOligo, [ms, mms], [gapo, gape]); 
            var score_oligo_ref_rv = bsa_align(locus.substring(BreakPoint-region_analyse*1, BreakPoint + region_analyse*1), ReverseComplement(targetingOligo), [ms, mms], [gapo, gape]);
            var oligo_index = score_oligo_ref_fw[0]>=score_oligo_ref_rv[0] ? score_oligo_ref_fw[1] : score_oligo_ref_rv[1]
            targetingOligo = score_oligo_ref_fw[0]>=score_oligo_ref_rv[0] ? targetingOligo: ReverseComplement(targetingOligo)
        }

    while (true) {
        var cursor1 = cursor;
        while (++cursor1<origlen && original[cursor1] != "\n");
        var cursor2 = cursor1+1;
        while (++cursor2<origlen && original[cursor2] != "\n");
        var cursor3 = cursor2+1;
        while (++cursor3<origlen && original[cursor3] != "\n");
        var cursor4 = cursor3+1;
        while (++cursor4<origlen && original[cursor4] != "\n");

        if (cursor4 >= origlen) break;
        else cursor = cursor4+1;

        var read = original.slice(cursor1+1,cursor2);
        gcContent[id].push(calculateGCContent(read)); 
        var phred = original.slice(cursor3+1,cursor4); 
        var readlen = read.length;
        var aln_type;

        var mean_phred = 0;
        for (let pos = 0; pos < readlen; pos++) {
            mean_phred = mean_phred + phred.charCodeAt(pos)-33;
        }
        mean_phred = mean_phred/readlen; 
        phred_array[id].push(mean_phred)
        if (readlen >10) {
            length_array[id].push(readlen)
        }
        
    
        if (mean_phred > PhredThreshold){ 
            if (targetingOligo !=""){
                var index_oli_read = read.search(targetingOligo);
                if (index_oli_read!=-1){
                    aln_type = 7;
                    // remove this part in knockin, speed up the program
                    var str1 = ''
                    str1 += read.substring(index_oli_read- oligo_index, index_oli_read- oligo_index + region_analyse*2)+ '\n'+ '\n';
                    if (aln_dict[id].hasOwnProperty(str1)){
                        aln_dict[id][str1][0]+=1
                    }
                    else {
                        aln_dict[id][str1] = Array(2)
                        aln_dict[id][str1][0] = 1
                        aln_dict[id][str1][1] = aln_type
                    }
                    }
                else {
                    index_oli_read = ReverseComplement(read).search(targetingOligo);
                    if (index_oli_read!=-1){
                        read = ReverseComplement(read)
                        aln_type = 7;
                    // remove this part in knockin, speed up the program
                        var str1 = ''
                        str1 += read.substring(index_oli_read- oligo_index, index_oli_read- oligo_index + region_analyse*2)+ '\n'+ '\n';
                        if (aln_dict[id].hasOwnProperty(str1)){
                            aln_dict[id][str1][0]+=1
                        }
                        else {
                            aln_dict[id][str1] = Array(2)
                            aln_dict[id][str1][0] = 1
                            aln_dict[id][str1][1] = aln_type
                        }
                    }

                    //Check WT manually, speed up
                    else if (read.includes(locus.substring(BreakPoint-region_analyse*1, BreakPoint + region_analyse*1))){
                        aln_type = 1;
                    // remove this part in knockin, speed up the program
                        var str1 = ''
                        str1 += locus.substring(BreakPoint-region_analyse*1, BreakPoint + region_analyse*1)+ '\n'+ '\n';
                        if (aln_dict[id].hasOwnProperty(str1)){
                            aln_dict[id][str1][0]+=1
                        }
                        else {
                            aln_dict[id][str1] = Array(2)
                            aln_dict[id][str1][0] = 1
                            aln_dict[id][str1][1] = aln_type
                        }
                    }
                    else if (read.includes(ReverseComplement(locus.substring(BreakPoint-region_analyse*1, BreakPoint + region_analyse*1)))){
                        aln_type = 1;
                        var str1 = ''
                        str1 += locus.substring(BreakPoint-region_analyse*1, BreakPoint + region_analyse*1)+ '\n'+ '\n';
                        if (aln_dict[id].hasOwnProperty(str1)){
                            aln_dict[id][str1][0]+=1
                        }
                        else {
                            aln_dict[id][str1] = Array(2)
                            aln_dict[id][str1][0] = 1
                            aln_dict[id][str1][1] = aln_type
                        }
                    }
                    
                    else if (!prime_mode){
                        // var check_roi = roi.some(roi1 => roi.includes(roi1));
                        if (read.includes(locus_check)||ReverseComplement(read).includes(locus_check)){// UPDATE v2.0 checking 4 posiblities of read, threshold score =region_analyse+10 
                            var rst = bsa_align(target, read, [ms, mms], [gapo, gape]);
                            if (rst[0] < (region_analyse*1)){
                                try{
                                read = ReverseComplement(read);
                                rst = bsa_align(target, read, [ms, mms], [gapo, gape]);
                                }
                                catch (error){}
                            }
                            var str1 = ''
                            var fmt1 = bsa_cigar2gaps_breakpoint(target, read, rst[1], rst[2], BreakPoint-region_analyse*1, BreakPoint + region_analyse*1);
                            var fmt = fmt1[0]
                            aln_type = fmt1[1]
                            // var str2_arr = fmt[0].split('-')
                            str1 += fmt[0] + '\n';
                            str1 += fmt[1] + '\n';
                            //aggregate aln track into dictionary
                            // if (containsAny(locus, str2_arr)||containsAny(ReverseComplement(locus), str2_arr)){
                            if (aln_type !=0){
                                if (aln_dict[id].hasOwnProperty(str1)){
                                    aln_dict[id][str1][0]+=1
                                }
                                else {
                                    aln_dict[id][str1] = Array(2)
                                    aln_dict[id][str1][0] = 1
                                    aln_dict[id][str1][1] = aln_type
                                }
                            }
                            if (str1.trim().length>(region_analyse*2-2)){
                            }
                        }           
                    }
                }
                    
            } 
            else {
                if (read.includes(locus_check)||ReverseComplement(read).includes(locus_check)){// UPDATE v2.0 checking 4 posiblities of read, threshold score =region_analyse+10 
                    var rst = bsa_align(target, read, [ms, mms], [gapo, gape]);
                    if (rst[0] < (region_analyse*1)){
                        try{
                        read = ReverseComplement(read);
                        rst = bsa_align(target, read, [ms, mms], [gapo, gape]);
                        }
                        catch (error){}
                    }
                    var str1 = ''
                    var fmt1 = bsa_cigar2gaps_breakpoint(target, read, rst[1], rst[2], BreakPoint-region_analyse*1, BreakPoint + region_analyse*1);
                    var fmt = fmt1[0]
                    aln_type = fmt1[1]
                    // var str2_arr = fmt[0].split('-')
                    str1 += fmt[0] + '\n';
                    str1 += fmt[1] + '\n';
                    //aggregate aln track into dictionary
                    // if (containsAny(locus, str2_arr)||containsAny(ReverseComplement(locus), str2_arr)){
                    if (aln_type !=0){
                        if (aln_dict[id].hasOwnProperty(str1)){
                            aln_dict[id][str1][0]+=1
                        }
                        else {
                            aln_dict[id][str1] = Array(2)
                            aln_dict[id][str1][0] = 1
                            aln_dict[id][str1][1] = aln_type
                        }
                    }
                    if (str1.trim().length>(region_analyse*2-2)){
                    }
                }           
            }
        }
    }
    RestFromLastChunk = original.substr(cursor);
    reader.result = "";
    reader = "";
    CurrentFileChunk++;

    if ((CurrentFileChunk)*chunksize >= files[CurrentFileId].size) //end of file -> next file
        {
            Pre_PlotAlignment(id, locus)
            PlotAlignment(id, locus)
            CurrentFileId++;
            CurrentFileChunk = 0;
            RestFromLastChunk = "";
        }

    if (CurrentFileId < files.length && CurrentFileId<96) {
        setTimeout("ReadNextFileChunk();",10);
    } else {
        DrawPie();
    }
    }

function FileReceived_off() {
    var original = RestFromLastChunk+reader.result;
    var cursor = 0, origlen = original.length;
    // alignment parameter for affine score DP algorithms 
    var ms = 1 // match score
    var mms = -1 //mismatch score
    var gapo = -4  // gap open score
    var gape = -1  // gap extent score
    // var id = CurrentFileId;
    while (true) {
        var cursor1 = cursor;
        while (++cursor1<origlen && original[cursor1] != "\n");
        var cursor2 = cursor1+1;
        while (++cursor2<origlen && original[cursor2] != "\n");
        var cursor3 = cursor2+1;
        while (++cursor3<origlen && original[cursor3] != "\n");
        var cursor4 = cursor3+1;
        while (++cursor4<origlen && original[cursor4] != "\n");
        if (cursor4 >= origlen) break;
        else cursor = cursor4+1;
        var read = original.slice(cursor1+1,cursor2);
        var phred = original.slice(cursor3+1,cursor4); 
        var readlen = read.length;
        var aln_type;
        var target = locus_list[gene_id];
        var targetingOligo = document.getElementsByName("TargetingOligo")[0].value.replace(/[\s\n]+/g, '').toUpperCase(); //TargetingOligo
        var mean_phred = 0;
        for (let pos = 0; pos < readlen; pos++) {
            mean_phred = mean_phred + phred.charCodeAt(pos);
        }
        mean_phred = mean_phred/readlen; 
    
        if (mean_phred > PhredThreshold){ 
            if ((targetingOligo !="") &&(read.includes(targetingOligo)||read.includes(ReverseComplement(targetingOligo))||read.includes(ReverseString(targetingOligo))||read.includes(ReverseComplement(ReverseString(targetingOligo))))){
                aln_type = 7;
                // remove this part in knockin, speed up the program
                hits_off[i].push(aln_type)
                var rst = bsa_align(target, read, [ms, mms], [gapo, gape]);
                var str1 = ''
                var fmt1 = bsa_cigar2gaps_breakpoint(target, read, rst[1], rst[2], BreakPoint-region_analyse*1, BreakPoint + region_analyse*1);
                var fmt = fmt1[0]
                            
                str1 += fmt[0] + '\n';
                str1 += fmt[1] + '\n';
                
                if (aln_dict_off[i].hasOwnProperty(str1)){
                    aln_dict_off[i][str1]+=1
                }
                else {
                    aln_dict_off[i][str1] = 1
                    aln_type_dict_off[i][str1] = aln_type
                }
                hits_off[i].push(aln_type)
            } 
            else {
                // UPDATE v2.0 checking 4 posiblities of read, threshold score =region_analyse+10
                if (read.includes(locus_list1[gene_id])||read.includes(ReverseComplement(locus_list1[gene_id]))){ 
                    var rst = bsa_align(target, read, [ms, mms], [gapo, gape]);
                    if (rst[0] < (region_analyse*1+10)){
                        try{
                        read = ReverseComplement(read);
                        rst = bsa_align(target, read, [ms, mms], [gapo, gape]);
                        }
                        catch (error){}
                    }
                    var str1 = ''
                    var fmt1 = bsa_cigar2gaps_breakpoint(target, read, rst[1], rst[2], BreakPoint-region_analyse*1, BreakPoint + region_analyse*1);
                    var fmt = fmt1[0]
                    aln_type = fmt1[1]
                    str1 += fmt[0] + '\n';
                    str1 += fmt[1] + '\n';
                    //aggregate aln track into dictionary
                    //if (containsAny(locus_list[gene_id], str2_arr)||containsAny(ReverseComplement(locus_list[gene_id]), str2_arr)){
                    //aggregate aln track into dictionary
                        if (aln_type !=0){
                            if (aln_dict_off[gene_id].hasOwnProperty(str1)){
                                aln_dict_off[gene_id][str1]+=1
                            }
                            else {
                                aln_dict_off[gene_id][str1] = 1
                                aln_type_dict_off[gene_id][str1] = aln_type
                            }
                        }
                        if (str1.length>(region_analyse*2-2)){
                            hits_off[gene_id].push(aln_type);
                        }          
                }
            }

        }
    }

    RestFromLastChunk = original.substr(cursor);
    reader.result = "";
    reader = "";
    CurrentFileChunk++;

    for (let key in aln_dict_off[gene_id]){
        sum_track_off[gene_id] += aln_dict_off[gene_id][key];
    }

    var not_align = 0;
    var no_indel = 0; 
    var inf_indel =  0;
    var out_indel = 0;
    var sum = 0;
    var read_ambigous =0;
    var targetingOligo = 0;
    for (let ii=0; ii<hits_off[gene_id].length; ii++){
        if (hits_off[gene_id][ii]>=0){
            switch (hits_off[gene_id][ii]){
                case 0:
                    not_align++;
                    break;
                case 1:
                    no_indel++;
                    sum++
                    break;
                case 2:
                    inf_indel++;
                    sum++
                    break;
                case 3: 
                    out_indel++;
                    sum++
                    break;
                case 7: 
                    targetingOligo++;
                    sum++
                    break;
                case 8: 
                    read_ambigous++;
            }
        }
    }
    // summary_track_off[gene_id][0] = total_read;
    summary_track_off[gene_id][1] = targetingOligo;
    summary_track_off[gene_id][2] = no_indel;
    summary_track_off[gene_id][3] = inf_indel;
    summary_track_off[gene_id][4] = out_indel;
    summary_track_off[gene_id][5] = read_ambigous;
    summary_track_off[gene_id][6] = not_align;
    summary_track_off[gene_id][7] = sum;

    for (let key in aln_dict_off[gene_id]){
        if ((aln_dict_off[gene_id][key]>10)&&(aln_dict_off[gene_id][key]>(1*summary_track_off[gene_id][7]/100))&&(key.split('\n')[0].trim().length>region_analyse*2-4)){
            aln_dict_fil_off[gene_id][key] = aln_dict_off[gene_id][key];
        }
    }
    
    // sort aligment tract
    var items = Object.keys(aln_dict_fil_off[gene_id]).map(function(key) {
    return [key, aln_dict_fil_off[gene_id][key]];
    });
    // Sort the array based on the second element
    items.sort(function(first, second) {
    return second[1] - first[1];
    });
    aln_dict_fil_off[gene_id] = Object.fromEntries(items.map(([v, k]) => [v, k]));
    if ((CurrentFileChunk)*chunksize >= files[CurrentFileId_off].size) //end of file -> next gene
        {
            PlotAlignment_off(gene_id)
            gene_id++;
            CurrentFileChunk = 0;
            RestFromLastChunk = "";
        }

    if (gene_id < gene_list.length && gene_id<4) {
        setTimeout("ReadNextFileChunk_off();",10);
    } 
    else {
    DrawPie_off();
    }
}

function ReadNextFileChunk()
{
    reader = new FileReader();
    reader.onload = FileReceived;
    reader.readAsText(files[CurrentFileId].slice(CurrentFileChunk*chunksize, (CurrentFileChunk+1)*chunksize));
    document.getElementById('progress').innerHTML = "File "+(CurrentFileId+1)+": "+Math.round(CurrentFileChunk*chunksize/1000000)+ "MB / "+Math.round(files[CurrentFileId].size/1000000)+" MB processed. Please keep this windows open!";
}

function ReadNextFileChunk_off(){
    reader = new FileReader();
    reader.onload = FileReceived_off;
    reader.readAsText(files[CurrentFileId_off].slice(CurrentFileChunk*chunksize, (CurrentFileChunk+1)*chunksize));
    document.getElementById('progress1').innerHTML = "OFFTARGET Gene: "+gene_list[gene_id] +" Analysing.\n Current file "+(CurrentFileId_off+1)+": "+Math.round(CurrentFileChunk*chunksize/1000000)+ "MB / "+Math.round(files[CurrentFileId_off].size/1000000)+" MB processed. Please keep this windows open!";
}

function DrawPie()
{
    var svg = document.getElementById("SVGpie");
    var NS="http://www.w3.org/2000/svg";
    TabClicked(1);
    //reset svg:
    while (svg.lastChild) svg.removeChild(svg.lastChild);
    //register mouse listener:
    svg.addEventListener("mousedown", PieClick, false);

    var ROT= ["rgb(232,0,30)","rgb(255,102,0)","rgb(252,176,78)"]; 
    var BLAU=["rgb(50,42,126)","rgb(16,115,179)","rgb(38,170,220)"];

    var maxsum = 0;
    for (var barcode=0; barcode<96; barcode++) {
        if (summary_track[barcode][7] > maxsum) maxsum = summary_track[barcode][7];
    }
    
    for (var barcode=0; barcode<96; barcode++){
        var sum = 0;
        var inf_indel1 =  Array(6)
        var out_indel1 = Array(6)
        var oligo = 0
        var wt = 0
        for (let i=0; i <6; i++){
            inf_indel1[i] = 0;
            out_indel1[i] = 0;
        }
        // classify indel into several subset
        for (let key in aln_dict_fil[barcode]){
            if (aln_dict[barcode][key][1] == 2){
                for (let i=0; i <6; i++){
                    if (inf_indel1[i]==0){
                        inf_indel1[i]=aln_dict_fil[barcode][key];
                        sum +=inf_indel1[i];
                        break;
                    }
                }
            } else if (aln_dict[barcode][key][1] == 3){
                for (let i=0; i <6; i++){
                    if (out_indel1[i]==0){
                        out_indel1[i]=aln_dict_fil[barcode][key];
                        sum += out_indel1[i];
                        break;
                    }
                }
            }
        }
        sum += summary_track[barcode][2]+ summary_track[barcode][1]

        var size = 24*Math.sqrt(sum/maxsum);
        var midx = (barcode%12)*50 + 25;
        var midy = Math.floor(barcode/12) * 65 + 25;
        if (summary_track[barcode][7] > 0) {
            //wt:
            var angle = -3.1415/2;
            var lastangle = angle;
            angle+=2*3.1415*0.995*summary_track[barcode][2]/sum;

            //SVG:
            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill="rgb(200,200,200)";

            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);

            // inframe indel1
            var lastangle = angle;
            angle+=2*3.1415*0.995*inf_indel1[0]/sum;

            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=BLAU[0];
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);

            // inframe indel2
            var lastangle = angle;
            angle+=2*3.1415*0.995*inf_indel1[1]/sum;

            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=BLAU[1];

            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);

            // inframe indel3
            var lastangle = angle;
            angle+=2*3.1415*0.995*inf_indel1[2]/sum;

            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=BLAU[2];
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);

            // inframe indel4
            var lastangle = angle;
            angle+=2*3.1415*0.995*inf_indel1[3]/sum;

            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=BLAU[0];
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);

            // inframe indel5
            var lastangle = angle;
            angle+=2*3.1415*0.995*inf_indel1[4]/sum;

            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=BLAU[1];

            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);

            // inframe indel6
            var lastangle = angle;
            angle+=2*3.1415*0.995*inf_indel1[5]/sum;

            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=BLAU[2];
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);
            
            // outframe indel1
            var lastangle = angle;
            angle+=2*3.1415*0.995*out_indel1[0]/sum;
            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=ROT[0];
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);

            // outframe indel2
            var lastangle = angle;
            angle+=2*3.1415*0.995*out_indel1[1]/sum;

            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=ROT[1];
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);

            // outframe indel3
            var lastangle = angle;
            angle+=2*3.1415*0.995*out_indel1[2]/sum;

            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=ROT[2];
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);

            // outframe indel4
            var lastangle = angle;
            angle+=2*3.1415*0.995*out_indel1[3]/sum;

            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=ROT[0];
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);

            // outframe indel5
            var lastangle = angle;
            angle+=2*3.1415*0.995*out_indel1[4]/sum;

            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=ROT[1];
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);

            // outframe indel6
            var lastangle = angle;
            angle+=2*3.1415*0.995*out_indel1[5]/sum;

            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=ROT[2];
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);
            // targetingOligo
            var lastangle = angle;
            angle+=2*3.1415*0.995*summary_track[barcode][1]/sum;

            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill="rgb(0,232,30)";
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);
            // read_ambigous, remove in v2.0
        }

        //SVG:
        var SVGObj= document.createElementNS(NS,"text");
        SVGObj.setAttribute("font-family", "sans-serif");
        SVGObj.setAttribute("font-weight", "100");
        SVGObj.setAttribute("x", midx);
        SVGObj.setAttribute("y", midy+36);
        SVGObj.setAttribute("font-size", "11");
        SVGObj.setAttribute("text-anchor", "middle");
        SVGObj.setAttribute("pointer-events","none");
        if (genotype[barcode]==''||!genotype[barcode]){
            SVGObj.textContent = GetWellPos(barcode)
        }
        else if (genotype[barcode]) {
            SVGObj.textContent = GetWellPos(barcode)+ " ("+ genotype[barcode]+ ")";
        }
        svg.appendChild(SVGObj);
    }
    //legende:
    var midx = 13*50 + 25;
    var midy = 0 * 65 + 25;
    for (var i=0; i<8; i++) {
        var vol = Math.floor(maxsum/100)*100/Math.pow(2,i);
        var size = 24*Math.sqrt(vol/maxsum);
        //SVG:
        var SVGObj= document.createElementNS(NS,"circle");
        SVGObj.setAttributeNS(null, "cx", midx);
        SVGObj.setAttributeNS(null, "cy", midy);
        SVGObj.setAttributeNS(null, "r" , size);
        SVGObj.style.fill="none";
        SVGObj.style.stroke="rgb(100,100,100)";
        svg.appendChild(SVGObj);
        var SVGObj= document.createElementNS(NS,"text");
        SVGObj.setAttribute("font-family", "sans-serif");
        SVGObj.setAttribute("font-weight", "100");
        SVGObj.setAttribute("x", midx+40);
        SVGObj.setAttribute("y", midy+3);
        SVGObj.setAttribute("font-size", "12");
        SVGObj.textContent = Math.round(vol) + " reads";
        svg.appendChild(SVGObj);
        midy += size*2+10;
    }
    for (var i=0; i<3; i++){
        var SVGObj= document.createElementNS(NS,"circle");
        SVGObj.setAttributeNS(null, "cx", midx +20*i -10);
        SVGObj.setAttributeNS(null, "cy", midy+30+20);
        SVGObj.setAttributeNS(null, "r" , 6);
        SVGObj.style.fill=BLAU[i];
        svg.appendChild(SVGObj);
    }
    for (var i=0; i<3; i++){
        SVGObj= document.createElementNS(NS,"circle");
        SVGObj.setAttributeNS(null, "cx", midx +20*i -10);
        SVGObj.setAttributeNS(null, "cy", midy+30+40);
        SVGObj.setAttributeNS(null, "r" , 6);
        SVGObj.style.fill=ROT[i];
        svg.appendChild(SVGObj);
    }

    SVGObj= document.createElementNS(NS,"circle");
    SVGObj.setAttributeNS(null, "cx", midx +10);
    SVGObj.setAttributeNS(null, "cy", midy+30+60);
    SVGObj.setAttributeNS(null, "r" , 6);
    SVGObj.style.fill="rgb(200,200,200)";
    svg.appendChild(SVGObj);

    SVGObj= document.createElementNS(NS,"circle");
    SVGObj.setAttributeNS(null, "cx", midx +10);
    SVGObj.setAttributeNS(null, "cy", midy+30+80);
    SVGObj.setAttributeNS(null, "r" , 6);
    SVGObj.style.fill="rgb(0,200,0)";
    svg.appendChild(SVGObj);
        
    var SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("font-family", "sans-serif");
    SVGObj.setAttribute("font-weight", "100");
    SVGObj.setAttribute("x", midx+50);
    SVGObj.setAttribute("y", midy+53);
    SVGObj.setAttribute("font-size", "12");
    SVGObj.textContent = "in-frame indels";
    svg.appendChild(SVGObj);
    var SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("font-family", "sans-serif");
    SVGObj.setAttribute("font-weight", "100");
    SVGObj.setAttribute("x", midx+50);
    SVGObj.setAttribute("y", midy+53+20);
    SVGObj.setAttribute("font-size", "12");
    SVGObj.textContent = "out-of-frame indels";
    svg.appendChild(SVGObj);
    var SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("font-family", "sans-serif");
    SVGObj.setAttribute("font-weight", "100");
    SVGObj.setAttribute("x", midx+50);
    SVGObj.setAttribute("y", midy+53+40);
    SVGObj.setAttribute("font-size", "12");
    SVGObj.textContent = "no indel";
    svg.appendChild(SVGObj);
    var SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("font-family", "sans-serif");
    SVGObj.setAttribute("font-weight", "100");
    SVGObj.setAttribute("x", midx+50);
    SVGObj.setAttribute("y", midy+53+60);
    SVGObj.setAttribute("font-size", "12");
    SVGObj.textContent = "targeted mutagenesis";
    svg.appendChild(SVGObj);
    document.title = "Result for "+document.getElementsByName("GeneName")[0].value+" ("+files.length+" barcodes read)";
}

function DrawPie_bulk()
{
    var svg = document.getElementById("SVGpie_bulk");
    var NS="http://www.w3.org/2000/svg";
    var barcode = CurrentAlignment;
    TabClicked(4);
    //reset svg:
    while (svg.lastChild) svg.removeChild(svg.lastChild);
    //register mouse listener:
    // svg.addEventListener("mousedown", PieClick, false);

    var ROT= ["rgb(232,0,30)","rgb(255,102,0)","rgb(252,176,78)"]; 
    var BLAU=["rgb(50,42,126)","rgb(16,115,179)","rgb(38,170,220)"];

    var size = 75;
    var midx = 100;
    var midy = 100;

    var sum = 0;
    var inf_indel1 =  Array(6)
    var out_indel1 = Array(6)
    var oligo
    for (let i=0; i <6; i++){
        inf_indel1[i] = 0;
        out_indel1[i] = 0;
    }

    for (let key in aln_dict_bulk){
        if (aln_dict[barcode][key][1] == 2){
            for (let i=0; i <6; i++){
                if (inf_indel1[i]==0){
                    inf_indel1[i]=aln_dict_bulk[key];
                    sum += inf_indel1[i]
                    break;
                }
            }
        } else if (aln_dict[barcode][key][1] == 3){
            for (let i=0; i <6; i++){
                if (out_indel1[i]==0){
                    out_indel1[i]=aln_dict_bulk[key];
                    sum += out_indel1[i]
                    break;
                }
            }
        }
    }

    sum += summary_track[barcode][2]+ summary_track[barcode][1]

    if (summary_track[barcode][7] > 0) {
        //wt:
        var angle = -3.1415/2;
        var lastangle = angle;
        angle+=2*3.1415*0.995*summary_track[barcode][2]/sum;
        //SVG:
        var startx = size*Math.cos(lastangle);
        var starty = size*Math.sin(lastangle);
        var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
        var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
        var largearc = 0;
        if (angle-lastangle > 3.1415) largearc = 1;
        var SVGObj= document.createElementNS(NS,"path");
        SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
        SVGObj.style.fill="rgb(200,200,200)";
        SVGObj.setAttribute("pointer-events","none");
        svg.appendChild(SVGObj);

        // inframe indel1
        lastangle = angle;
        angle+=2*3.1415*0.995*inf_indel1[0]/sum;
        startx = size*Math.cos(lastangle);
        starty = size*Math.sin(lastangle);
        plusx = size*(Math.cos(angle)-Math.cos(lastangle));
        plusy = size*(Math.sin(angle)-Math.sin(lastangle));
        largearc = 0;
        if (angle-lastangle > 3.1415) largearc = 1;
        SVGObj= document.createElementNS(NS,"path");
        SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
        SVGObj.style.fill=BLAU[0];
        SVGObj.setAttribute("pointer-events","none");
        svg.appendChild(SVGObj);

        // inframe indel2
        lastangle = angle;
        angle+=2*3.1415*0.995*inf_indel1[1]/sum;
        startx = size*Math.cos(lastangle);
        starty = size*Math.sin(lastangle);
        plusx = size*(Math.cos(angle)-Math.cos(lastangle));
        plusy = size*(Math.sin(angle)-Math.sin(lastangle));
        var largearc = 0;
        if (angle-lastangle > 3.1415) largearc = 1;
        SVGObj= document.createElementNS(NS,"path");
        SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
        SVGObj.style.fill=BLAU[1];
        SVGObj.setAttribute("pointer-events","none");
        svg.appendChild(SVGObj);

        // inframe indel3
        lastangle = angle;
        angle+=2*3.1415*0.995*inf_indel1[2]/sum;
        startx = size*Math.cos(lastangle);
        starty = size*Math.sin(lastangle);
        plusx = size*(Math.cos(angle)-Math.cos(lastangle));
        plusy = size*(Math.sin(angle)-Math.sin(lastangle));
        largearc = 0;
        if (angle-lastangle > 3.1415) largearc = 1;
        SVGObj= document.createElementNS(NS,"path");
        SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
        SVGObj.style.fill=BLAU[2];
        SVGObj.setAttribute("pointer-events","none");
        svg.appendChild(SVGObj);

        // inframe indel4
        lastangle = angle;
        angle+=2*3.1415*0.995*inf_indel1[3]/sum;
        startx = size*Math.cos(lastangle);
        starty = size*Math.sin(lastangle);
        plusx = size*(Math.cos(angle)-Math.cos(lastangle));
        plusy = size*(Math.sin(angle)-Math.sin(lastangle));
        largearc = 0;
        if (angle-lastangle > 3.1415) largearc = 1;
        SVGObj= document.createElementNS(NS,"path");
        SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
        SVGObj.style.fill=BLAU[0];
        SVGObj.setAttribute("pointer-events","none");
        svg.appendChild(SVGObj);

        // inframe indel5
        lastangle = angle;
        angle+=2*3.1415*0.995*inf_indel1[4]/sum;
        startx = size*Math.cos(lastangle);
        starty = size*Math.sin(lastangle);
        plusx = size*(Math.cos(angle)-Math.cos(lastangle));
        plusy = size*(Math.sin(angle)-Math.sin(lastangle));
        largearc = 0;
        if (angle-lastangle > 3.1415) largearc = 1;
        SVGObj= document.createElementNS(NS,"path");
        SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
        SVGObj.style.fill=BLAU[1];
        SVGObj.setAttribute("pointer-events","none");
        svg.appendChild(SVGObj);

        // inframe indel6
        lastangle = angle;
        angle+=2*3.1415*0.995*inf_indel1[5]/sum;
        startx = size*Math.cos(lastangle);
        starty = size*Math.sin(lastangle);
        plusx = size*(Math.cos(angle)-Math.cos(lastangle));
        plusy = size*(Math.sin(angle)-Math.sin(lastangle));
        largearc = 0;
        if (angle-lastangle > 3.1415) largearc = 1;
        SVGObj= document.createElementNS(NS,"path");
        SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
        SVGObj.style.fill=BLAU[2];
        SVGObj.setAttribute("pointer-events","none");
        svg.appendChild(SVGObj);

        // outframe indel1
        lastangle = angle;
        angle+=2*3.1415*0.995*out_indel1[0]/sum;
        startx = size*Math.cos(lastangle);
        starty = size*Math.sin(lastangle);
        plusx = size*(Math.cos(angle)-Math.cos(lastangle));
        plusy = size*(Math.sin(angle)-Math.sin(lastangle));
        largearc = 0;
        if (angle-lastangle > 3.1415) largearc = 1;
        SVGObj= document.createElementNS(NS,"path");
        SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
        SVGObj.style.fill=ROT[0];
        SVGObj.setAttribute("pointer-events","none");
        svg.appendChild(SVGObj);

        // outframe indel2
        lastangle = angle;
        angle+=2*3.1415*0.995*out_indel1[1]/sum;
        startx = size*Math.cos(lastangle);
        starty = size*Math.sin(lastangle);
        plusx = size*(Math.cos(angle)-Math.cos(lastangle));
        plusy = size*(Math.sin(angle)-Math.sin(lastangle));
        largearc = 0;
        if (angle-lastangle > 3.1415) largearc = 1;
        SVGObj= document.createElementNS(NS,"path");
        SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
        SVGObj.style.fill=ROT[1];
        SVGObj.setAttribute("pointer-events","none");
        svg.appendChild(SVGObj);

        // outframe indel3
        lastangle = angle;
        angle+=2*3.1415*0.995*out_indel1[2]/sum;
        startx = size*Math.cos(lastangle);
        starty = size*Math.sin(lastangle);
        plusx = size*(Math.cos(angle)-Math.cos(lastangle));
        plusy = size*(Math.sin(angle)-Math.sin(lastangle));
        largearc = 0;
        if (angle-lastangle > 3.1415) largearc = 1;
        SVGObj= document.createElementNS(NS,"path");
        SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
        SVGObj.style.fill=ROT[2];
        SVGObj.setAttribute("pointer-events","none");
        svg.appendChild(SVGObj);

        // outframe indel4
        lastangle = angle;
        angle+=2*3.1415*0.995*out_indel1[3]/sum;
        startx = size*Math.cos(lastangle);
        starty = size*Math.sin(lastangle);
        plusx = size*(Math.cos(angle)-Math.cos(lastangle));
        plusy = size*(Math.sin(angle)-Math.sin(lastangle));
        largearc = 0;
        if (angle-lastangle > 3.1415) largearc = 1;
        SVGObj= document.createElementNS(NS,"path");
        SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
        SVGObj.style.fill=ROT[0];
        SVGObj.setAttribute("pointer-events","none");
        svg.appendChild(SVGObj);

        // outframe indel5
        lastangle = angle;
        angle+=2*3.1415*0.995*out_indel1[4]/sum;
        startx = size*Math.cos(lastangle);
        starty = size*Math.sin(lastangle);
        plusx = size*(Math.cos(angle)-Math.cos(lastangle));
        plusy = size*(Math.sin(angle)-Math.sin(lastangle));
        largearc = 0;
        if (angle-lastangle > 3.1415) largearc = 1;
        SVGObj= document.createElementNS(NS,"path");
        SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
        SVGObj.style.fill=ROT[1];
        SVGObj.setAttribute("pointer-events","none");
        svg.appendChild(SVGObj);

        // outframe indel6
        lastangle = angle;
        angle+=2*3.1415*0.995*out_indel1[5]/sum;
        startx = size*Math.cos(lastangle);
        starty = size*Math.sin(lastangle);
        plusx = size*(Math.cos(angle)-Math.cos(lastangle));
        plusy = size*(Math.sin(angle)-Math.sin(lastangle));
        largearc = 0;
        if (angle-lastangle > 3.1415) largearc = 1;
        SVGObj= document.createElementNS(NS,"path");
        SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
        SVGObj.style.fill=ROT[2];
        SVGObj.setAttribute("pointer-events","none");
        svg.appendChild(SVGObj);
        // targetingOligo
        lastangle = angle;
        angle+=2*3.1415*0.995*summary_track[barcode][1]/sum;
        startx = size*Math.cos(lastangle);
        starty = size*Math.sin(lastangle);
        plusx = size*(Math.cos(angle)-Math.cos(lastangle));
        plusy = size*(Math.sin(angle)-Math.sin(lastangle));
        largearc = 0;
        if (angle-lastangle > 3.1415) largearc = 1;
        SVGObj= document.createElementNS(NS,"path");
        SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
        SVGObj.style.fill="rgb(0,232,30)";
        SVGObj.setAttribute("pointer-events","none");
        svg.appendChild(SVGObj);
        }

        //SVG:
        SVGObj= document.createElementNS(NS,"text");
        SVGObj.setAttribute("font-family", "sans-serif");
        SVGObj.setAttribute("font-weight", "100");
        SVGObj.setAttribute("x", midx);
        SVGObj.setAttribute("y", midy+36);
        SVGObj.setAttribute("font-size", "11");
        SVGObj.setAttribute("text-anchor", "middle");
        SVGObj.setAttribute("pointer-events","none");
        SVGObj.textContent = GetWellPos(barcode);
        svg.appendChild(SVGObj);

    //legende:
    midx = 25;
    midy = 200;
    for (var i=0; i<3; i++){
        SVGObj= document.createElementNS(NS,"circle");
        SVGObj.setAttributeNS(null, "cx", midx+20*i);
        SVGObj.setAttributeNS(null, "cy", midy);
        SVGObj.setAttributeNS(null, "r" , 6);
        SVGObj.style.fill="none";
        SVGObj.style.fill=BLAU[i];
        svg.appendChild(SVGObj);
    }
    for (var i=0; i<3; i++){
        SVGObj= document.createElementNS(NS,"circle");
        SVGObj.setAttributeNS(null, "cx", midx+20*i);
        SVGObj.setAttributeNS(null, "cy", midy +20);
        SVGObj.setAttributeNS(null, "r" , 6);
        SVGObj.style.fill="none";
        SVGObj.style.fill=ROT[i];
        svg.appendChild(SVGObj);
    }
        SVGObj= document.createElementNS(NS,"circle");
        SVGObj.setAttributeNS(null, "cx", midx+20);
        SVGObj.setAttributeNS(null, "cy", midy +40);
        SVGObj.setAttributeNS(null, "r" , 6);
        SVGObj.style.fill="none";
        SVGObj.style.fill="rgb(200,200,200)";
        svg.appendChild(SVGObj);

        SVGObj= document.createElementNS(NS,"circle");
        SVGObj.setAttributeNS(null, "cx", midx+20);
        SVGObj.setAttributeNS(null, "cy", midy +60);
        SVGObj.setAttributeNS(null, "r" , 6);
        SVGObj.style.fill="none";
        SVGObj.style.fill="rgb(0,200,0)";
        svg.appendChild(SVGObj);
    

    SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("font-family", "sans-serif");
    SVGObj.setAttribute("font-weight", "100");
    SVGObj.setAttribute("x", midx+80);
    SVGObj.setAttribute("y", midy);
    SVGObj.setAttribute("font-size", "12");
    SVGObj.textContent = "in-frame indels: "+ summary_track_select[barcode+1][3]+ " %";
    svg.appendChild(SVGObj);
    SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("font-family", "sans-serif");
    SVGObj.setAttribute("font-weight", "100");
    SVGObj.setAttribute("x", midx+80);
    SVGObj.setAttribute("y", midy+20)
    SVGObj.setAttribute("font-size", "12");
    SVGObj.textContent = "out-of-frame indels: "+ summary_track_select[barcode+1][4]+ " %";
    svg.appendChild(SVGObj);
    SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("font-family", "sans-serif");
    SVGObj.setAttribute("font-weight", "100");
    SVGObj.setAttribute("x", midx+80);
    SVGObj.setAttribute("y", midy+40)
    SVGObj.setAttribute("font-size", "12");
    SVGObj.textContent = "no indel: "+ summary_track_select[barcode+1][2]+ " %";
    svg.appendChild(SVGObj);
    SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("font-family", "sans-serif");
    SVGObj.setAttribute("font-weight", "100");
    SVGObj.setAttribute("x", midx+80);
    SVGObj.setAttribute("y", midy+60)
    SVGObj.setAttribute("font-size", "12");
    SVGObj.textContent = "targeted mutagenesis (KI): "+ summary_track_select[barcode+1][1]+ " %";
    svg.appendChild(SVGObj);

    // Parse FASTQ data and extract quality scores

    const qualityScores = phred_array[barcode];
    const binnedQualityScores = binQualityScores(qualityScores, 1);

    // Create histogram data
    const histogramData = [
            {
                x: binnedQualityScores.map((count, index) => index * 1),
                y: binnedQualityScores,
                type: 'bar'
            }
        ];

    // Set layout
    const layout = {
        title: 'Quality Score Histogram',
        xaxis: {
            title: 'PHRED Quality Score',
            range: [-10, 60], // Set the x-axis range from 0 to 40
            dtick: 5
        },
        yaxis: {
            title: 'Count'
        }
    };

    // Plot
    Plotly.newPlot('QC_plot', histogramData, layout);

    // Parse FASTQ data and extract quality scores
    const read_length = length_array[barcode];

    // Create histogram data
    const histogramData1 = [
        {
            x: read_length,
            type: 'histogram'
        }
    ];

    // Set layout
    const layout1 = {
        title: 'Read Length Distribution',
        xaxis: {
            title: 'Read length (bp)',
            range: [-10, 1000], // Set the x-axis range from 0 to 40
        },
        yaxis: {
            title: 'Count'
        }
    };

    // Plot
    Plotly.newPlot('read_plot', histogramData1, layout1);


       // Parse FASTQ data and extract quality scores

    const gcData = gcContent[barcode];
    const binnedgcData = binQualityScores(gcData, 1);

    // Create histogram data
    const histogramData2 = [
            {
                x: binnedgcData.map((count, index) => index * 1),
                y: binnedgcData,
                type: 'bar'
            }
        ];

    // Set layout
    const layout2 = {
        title: 'GC Content Histogram',
        xaxis: {
            title: 'GC Content %',
            range: [10, 70], // Set the x-axis range from 0 to 40
            dtick: 5
        },
        yaxis: {
            title: 'Count'
        }
    };

    // Plot
    Plotly.newPlot('GC_plot', histogramData2, layout2);

    document.title = "Bulk Result for "+document.getElementsByName("GeneName")[0].value+" ("+files.length+" barcodes read)";
}

function DrawPie_off()
{
    var svg = document.getElementById("SVGpie_off");
    var NS="http://www.w3.org/2000/svg";

    TabClicked(5);
    //reset svg:
    while (svg.lastChild) svg.removeChild(svg.lastChild);

    //register mouse listener:
    svg.addEventListener("mousedown", PieClick_off, false);

    var ROT= ["rgb(232,0,30)","rgb(255,102,0)","rgb(252,176,78)"]; 
    var BLAU=["rgb(50,42,126)","rgb(16,115,179)","rgb(38,170,220)"];

    var maxsum = 0;
    for (var barcode=0; barcode<4; barcode++) {
        if (summary_track_off[barcode][7] > maxsum) maxsum = summary_track_off[barcode][7];
    }
    
    for (var barcode=0; barcode<4; barcode++) {
        var sum = 0;
        var gene_i = barcode;
        var inf_indel1 =  Array(6)
        var out_indel1 = Array(6)
        var oligo
        for (let i=0; i <6; i++){
            inf_indel1[i] = 0;
            out_indel1[i] = 0;
        }
        // classify indel into several subset
        for (let key in aln_dict_fil_off[barcode]){
            if (aln_type_dict_off[barcode][key] == 2){
                for (let i=0; i <6; i++){
                    if (inf_indel1[i]==0){
                        inf_indel1[i]=aln_dict_fil_off[barcode][key];
                        break;
                    }
                }
            } else if (aln_type_dict_off[barcode][key] == 3){
                for (let i=0; i <6; i++){
                    if (out_indel1[i]==0){
                        out_indel1[i]=aln_dict_fil_off[barcode][key];
                        break;
                    }
                }
            }
        }
        
        var size = 2*24*Math.sqrt(summary_track_off[barcode][7]/maxsum);
        var midx = (barcode%12)*180 + 300;
        var midy = Math.floor(barcode/12) * 65 + 100;

        if (summary_track_off[barcode][7] > 0) {
            //wt:
            var angle = -3.1415/2;
            var lastangle = angle;
            angle+=2*3.1415*0.995*summary_track_off[barcode][2]/summary_track_off[barcode][7];

            //SVG:
            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill="rgb(200,200,200)";

            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);

            // inframe indel1
            var lastangle = angle;
            angle+=2*3.1415*0.995*inf_indel1[0]/summary_track_off[barcode][7];

            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=BLAU[0];
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);

            // inframe indel2
            var lastangle = angle;
            angle+=2*3.1415*0.995*inf_indel1[1]/summary_track_off[barcode][7];

            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=BLAU[1];

            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);

            // inframe indel3
            var lastangle = angle;
            angle+=2*3.1415*0.995*inf_indel1[2]/summary_track_off[barcode][7];

            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=BLAU[2];
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);

            // inframe indel4
            var lastangle = angle;
            angle+=2*3.1415*0.995*inf_indel1[3]/summary_track_off[barcode][7];

            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=BLAU[0];
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);

            // inframe indel5
            var lastangle = angle;
            angle+=2*3.1415*0.995*inf_indel1[4]/summary_track_off[barcode][7];

            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=BLAU[1];

            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);

            // inframe indel6
            var lastangle = angle;
            angle+=2*3.1415*0.995*inf_indel1[5]/summary_track_off[barcode][7];

            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=BLAU[2];
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);
            
            // outframe indel1
            var lastangle = angle;
            angle+=2*3.1415*0.995*out_indel1[0]/summary_track_off[barcode][7];
            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=ROT[0];
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);

            // outframe indel2
            var lastangle = angle;
            angle+=2*3.1415*0.995*out_indel1[1]/summary_track_off[barcode][7];

            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=ROT[1];
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);

            // outframe indel3
            var lastangle = angle;
            angle+=2*3.1415*0.995*out_indel1[2]/summary_track_off[barcode][7];

            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=ROT[2];
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);

            // outframe indel4
            var lastangle = angle;
            angle+=2*3.1415*0.995*out_indel1[3]/summary_track_off[barcode][7];

            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=ROT[0];
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);

            // outframe indel5
            var lastangle = angle;
            angle+=2*3.1415*0.995*out_indel1[4]/summary_track_off[barcode][7];

            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=ROT[1];
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);

            // outframe indel6
            var lastangle = angle;
            angle+=2*3.1415*0.995*out_indel1[5]/summary_track_off[barcode][7];

            var startx = size*Math.cos(lastangle);
            var starty = size*Math.sin(lastangle);
            var plusx = size*(Math.cos(angle)-Math.cos(lastangle));
            var plusy = size*(Math.sin(angle)-Math.sin(lastangle));
            var largearc = 0;
            if (angle-lastangle > 3.1415) largearc = 1;
            var SVGObj= document.createElementNS(NS,"path");
            SVGObj.setAttributeNS(null, "d", "M "+midx+","+midy+" l "+startx+","+starty+" a "+size+" "+size+" 0 "+largearc+" 1 "+plusx+" "+plusy+" z");
            SVGObj.style.fill=ROT[2];
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);
            // read_ambigous, remove in v2.0
        }

        //SVG:
        var SVGObj= document.createElementNS(NS,"text");
        SVGObj.setAttribute("font-family", "sans-serif");
        SVGObj.setAttribute("font-weight", "200");
        SVGObj.setAttribute("x", midx);
        SVGObj.setAttribute("y", midy+120);
        SVGObj.setAttribute("font-size", "14");
        SVGObj.setAttribute("text-anchor", "middle");
        SVGObj.setAttribute("font-weight", "600");
        SVGObj.setAttribute("pointer-events","none");
        SVGObj.textContent = gene_list[barcode];
        svg.appendChild(SVGObj);

        SVGObj= document.createElementNS(NS,"text");
        SVGObj.setAttribute("x", midx);
        SVGObj.setAttribute("y", midy+150);
        SVGObj.setAttribute("font-size", "14");
        SVGObj.setAttribute("text-anchor", "middle");
        SVGObj.textContent = summary_track_off[gene_i][7]
        svg.appendChild(SVGObj);

        SVGObj= document.createElementNS(NS,"text");
        SVGObj.setAttribute("x", midx);
        SVGObj.setAttribute("y", midy+170);
        SVGObj.setAttribute("font-size", "14");
        SVGObj.setAttribute("text-anchor", "middle");
        SVGObj.textContent = summary_track_off[gene_i][3]+ " Reads, (" +divide_zero(summary_track_off[gene_i][3]*100, summary_track_off[gene_i][7]).toFixed(2)+"%)";
        svg.appendChild(SVGObj);

        SVGObj= document.createElementNS(NS,"text");
        SVGObj.setAttribute("x", midx);
        SVGObj.setAttribute("y", midy+190);
        SVGObj.setAttribute("font-size", "14");
        SVGObj.setAttribute("text-anchor", "middle");
        SVGObj.textContent = summary_track_off[gene_i][4]+ " Reads, (" +divide_zero(summary_track_off[gene_i][4]*100,summary_track_off[gene_i][7]).toFixed(2)+"%)" 
        svg.appendChild(SVGObj);

        SVGObj= document.createElementNS(NS,"text");
        SVGObj.setAttribute("x", midx);
        SVGObj.setAttribute("y", midy+210);
        SVGObj.setAttribute("font-size", "14");
        SVGObj.setAttribute("text-anchor", "middle");
        SVGObj.textContent = summary_track_off[gene_i][2] +" Reads, (" +divide_zero(summary_track_off[gene_i][2]*100,summary_track_off[gene_i][7]).toFixed(2) +"%)" 
        svg.appendChild(SVGObj);

        var imageElement = document.createElementNS(NS, "image");
        imageElement.setAttribute("x", midx-15);
        imageElement.setAttribute("y", midy+250);
        if (summary_track_off[gene_i][7] <5 || divide_zero(summary_track_off[gene_i][4]*100,summary_track_off[gene_i][7])< 2){
        imageElement.setAttribute("href", "crisprnano2/OK.ico");
        imageElement.setAttribute("width", 40); // Set the width of the image
        imageElement.setAttribute("height", 40); // Set the height of the image 
        }
        else {
            imageElement.setAttribute("href", "crisprnano2/warning.png"); // Set the path to your image file
            imageElement.setAttribute("width", 80); // Set the width of the image
            imageElement.setAttribute("height", 80); // Set the height of the image
            imageElement.setAttribute("x", midx-30);
            imageElement.setAttribute("y", midy+230);
        }
        svg.appendChild(imageElement);
    }

        //legende:
    midx = 25;
    midy = 270;
    for (var i=0; i<3; i++){
        SVGObj= document.createElementNS(NS,"circle");
        SVGObj.setAttributeNS(null, "cx", midx+20*i);
        SVGObj.setAttributeNS(null, "cy", midy);
        SVGObj.setAttributeNS(null, "r" , 6);
        SVGObj.style.fill="none";
        SVGObj.style.fill=BLAU[i];
        svg.appendChild(SVGObj);
    }
    for (var i=0; i<3; i++){
        SVGObj= document.createElementNS(NS,"circle");
        SVGObj.setAttributeNS(null, "cx", midx+20*i);
        SVGObj.setAttributeNS(null, "cy", midy +20);
        SVGObj.setAttributeNS(null, "r" , 6);
        SVGObj.style.fill="none";
        SVGObj.style.fill=ROT[i];
        svg.appendChild(SVGObj);
    }
    SVGObj= document.createElementNS(NS,"circle");
    SVGObj.setAttributeNS(null, "cx", midx+20);
    SVGObj.setAttributeNS(null, "cy", midy +40);
    SVGObj.setAttributeNS(null, "r" , 6);
    SVGObj.style.fill="none";
    SVGObj.style.fill="rgb(200,200,200)";
    svg.appendChild(SVGObj);

    SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("font-family", "sans-serif");
    SVGObj.setAttribute("font-weight", "100");
    SVGObj.setAttribute("x", midx+80);
    SVGObj.setAttribute("y", midy-20);
    SVGObj.setAttribute("font-size", "12");
    SVGObj.textContent = "TOTAL ALIGNED READS "
    svg.appendChild(SVGObj);

    SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("font-family", "sans-serif");
    SVGObj.setAttribute("font-weight", "100");
    SVGObj.setAttribute("x", midx+80);
    SVGObj.setAttribute("y", midy);
    SVGObj.setAttribute("font-size", "12");
    SVGObj.textContent = "in-frame indels: "
    svg.appendChild(SVGObj);
    SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("font-family", "sans-serif");
    SVGObj.setAttribute("font-weight", "100");
    SVGObj.setAttribute("x", midx+80);
    SVGObj.setAttribute("y", midy+20)
    SVGObj.setAttribute("font-size", "12");
    SVGObj.textContent = "out-of-frame indels: "
    svg.appendChild(SVGObj);
    SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("font-family", "sans-serif");
    SVGObj.setAttribute("font-weight", "100");
    SVGObj.setAttribute("x", midx+80);
    SVGObj.setAttribute("y", midy+40)
    SVGObj.setAttribute("font-size", "12");
    SVGObj.textContent = "no indel: "
    svg.appendChild(SVGObj);
 
    document.title = "Off-target Result for "+document.getElementsByName("GeneName")[0].value+" ("+files.length+" barcodes read)";
}

function PieClick(evt){
    var top = document.getElementById("SVGpie").getBoundingClientRect().top;
    var left = document.getElementById("SVGpie").getBoundingClientRect().left;
    var x = evt.clientX-left;
    var y = evt.clientY-top;
    var xx = Math.round((x-25)/50);
    var yy = Math.round((y-25)/65);
    SelectClone(xx+12*yy);
}

function PieClick_off(evt){
    var top1 = document.getElementById("SVGpie_off").getBoundingClientRect().top;
    var left = document.getElementById("SVGpie_off").getBoundingClientRect().left;
    var x = evt.clientX-left;
    var y = evt.clientY-top1;
    var xx = Math.round((x-300)/180);
    var yy = Math.round((y-100)/65);
    SelectClone_off(xx+12*yy);
}

function SelectClone(barcode) {
    bulkview = document.getElementById("bulkview").checked;
    if (bulkview){
        if (AlignmentPrecalc[barcode]){
            CurrentAlignment = barcode;
            AlignmentStartPos = 0;
            PlotAlignment_bulk(barcode, locus, bulk_threshold)
            document.getElementById("DIV_alignment_bulk").innerHTML = AlignmentPrecalc_bulk;
            PlotAlignment_bulk(barcode, locus, bulk_threshold)
            DrawPie_bulk();
        }
    } 
    else if (AlignmentPrecalc[barcode]){
            document.getElementById("DIV_alignment").innerHTML = AlignmentPrecalc[barcode];
            CurrentAlignment = barcode;
            AlignmentStartPos = 0;
            Pre_PlotAlignment(barcode, locus);

            PlotAlignment(barcode, locus);
            }
    else alert("No data available for the selected barcode.");
}

function SelectClone_off(barcode) {
    if (AlignmentPrecalc_off[barcode]){
            CurrentAlignment_off = barcode;
            AlignmentStartPos = 0;
            PlotAlignment_off(CurrentAlignment_off)
            document.getElementById("DIV_alignment_off").innerHTML = AlignmentPrecalc_off[barcode];
            PlotAlignment_off(CurrentAlignment_off)
        }
    else alert("No data available for the selected barcode.");
}

function GetWellPos(i)
{
    var ABC = "ABCDEFGHIJKL";
    return ABC[Math.floor(i/12)] + ((i%12)+1);
}

//Prepare Alignment function that summaries static variable for plot:

function Pre_PlotAlignment(barcode, locus){
    //compute number of aligned read
    // check genotype
    var id = barcode;

    for (let key in aln_dict[id]){
        sum_track[id] += aln_dict[id][key][0];
    }
    var read_ambigous =0;

    for (let key in aln_dict[id]){
        if (aln_dict[id][key][1]==8){
                read_ambigous++;
            }
    }
    summary_track[id][0] = sum + read_ambigous;
    summary_track[id][5] = read_ambigous;
    // summary_track[id][6] = not_align;
    summary_track[id][7] = sum;
    alert(summary_track[id][7])
    for (let key in aln_dict[id]){
        if ((aln_dict[id][key][1]!=8)&&(aln_dict[id][key][0]>10)&&(aln_dict[id][key][0]>(1*MutationThreshold*sum_track[id]/100))&&(key.split('\n')[0].trim().length>region_analyse*2-4)){
            aln_dict_fil[id][key] = aln_dict[id][key][0];
        }
    }
    
    no_indel[barcode] = 0; 
    no_indel_arr[barcode] = []
    inf_indel[barcode] =  0;
    out_indel[barcode] = 0;
    out_indel_arr[barcode] = []
    sum[barcode]= 0;
    targetingOligo[barcode] = 0;
    targetingOligo_arr[barcode] = [];

    for (let key in aln_dict_fil[id]){
        switch (aln_dict[id][key][1]){
            case 1:
                no_indel[barcode]+=aln_dict_fil[id][key];
                no_indel_arr[barcode][key] = aln_dict_fil[id][key];
                break;
            case 2:
                inf_indel[barcode]+=aln_dict_fil[id][key];
                break;
            case 3: 
                out_indel[barcode]+=aln_dict_fil[id][key];
                out_indel_arr[barcode].push(aln_dict_fil[id][key])
                break;
            case 7: 
                targetingOligo[barcode]+=aln_dict_fil[id][key];
                targetingOligo_arr[barcode].push(aln_dict_fil[id][key])
                break;
        }
    }
    
    //update new WT candidate, keep maximum
    if (Object.keys(no_indel_arr[barcode]).length >1){
        let maxValue = -Infinity;
            var sum_wt = 0;
            var candidate_wt;
            for (const key1 in no_indel_arr[barcode]) {
                const value = no_indel_arr[barcode][key1];
                if (value > maxValue) {
                maxValue = value;
                candidate_wt = key1;
                }
                sum_wt += value;
                delete aln_dict_fil[id][key1];
            }
            //update new candidate WT (max)
            aln_dict_fil[id][candidate_wt] = sum_wt;
    }

    // For saving csv
    summary_track[id][1] = targetingOligo[barcode];
    summary_track[id][2] = no_indel[barcode];
    summary_track[id][3] = inf_indel[barcode];
    summary_track[id][4] = out_indel[barcode];
    summary_track[id][7] = no_indel[barcode]+inf_indel[barcode]+out_indel[barcode]+targetingOligo[barcode];
    if (summary_track[id][7]>0) {
        summary_track_select[id+1] =  [GetWellPos(id), (targetingOligo[barcode]/summary_track[id][7]*100).toFixed(2), (no_indel[barcode]/summary_track[id][7]*100).toFixed(2), (inf_indel[barcode]/summary_track[id][7]*100).toFixed(2), (out_indel[barcode]/summary_track[id][7]*100).toFixed(2), summary_track[id][7]]
    }
    else {
        summary_track_select[id+1] =  [GetWellPos(id), targetingOligo[barcode], no_indel[barcode], inf_indel[barcode], out_indel[barcode], summary_track[id][7]]
    }

    // check genotype
    if (summary_track[id][7] > 50) {
        if (targetingOligo[barcode]/summary_track[id][7] > 0.95) {
            if (targetingOligo_arr[barcode].length==2) {
                if (targetingOligo_arr[barcode][0]/(targetingOligo_arr[barcode][0]+targetingOligo_arr[barcode][1])>0.3 ||targetingOligo_arr[barcode][0]/(targetingOligo_arr[barcode][0]+targetingOligo_arr[barcode][1])<0.7){
                    genotype[id] = 'KI/KI'
                }
                else {
                    genotype[id] = 'KI'
                }
            }
            else {
                    genotype[id] = 'KI'
                }
        }
        else if (Object.keys(aln_dict_fil[id]).length ==2) {
            if ((out_indel[barcode]/summary_track[id][7] < 0.7)&& (inf_indel[barcode]/summary_track[id][7] < 0.7) && (targetingOligo[barcode]/summary_track[id][7]<0.7)) {
            genotype[id] = 'HET'
            }
            else if ((out_indel[barcode]/summary_track[id][7] >0.95)&& (out_indel_arr[barcode].length ==2)&& (out_indel_arr[barcode][0]/summary_track[id][7] > 0.35)&& (out_indel_arr[barcode][0]/summary_track[id][7] < 0.65)) {
                genotype[id] = 'KO'
            }
        }
        else {
            genotype[id] = ''
        }
    }

    // sort aligment tract
    var items = Object.keys(aln_dict_fil[id]).map(function(key) {
    return [key, aln_dict_fil[id][key]];
    });
    // Sort the array based on the second element
    items.sort(function(first, second) {
    return second[1] - first[1];
    });
    aln_dict_fil[id] = Object.fromEntries(items.map(([v, k]) => [v, k]));
    

}

function PlotAlignment(barcode, locus){

    var id = barcode;
    
    //aggregate aln_track
    //Find top 3:
    var aln_type = ["Not align","No indel", "Inframe Indel", "Outframe indel", "", "","", "targetingOligo", "Ambigious"]
    var ysize = 30;
    var max=0;
    
    var svg = document.getElementById("SVGmut");
    var NS="http://www.w3.org/2000/svg";
    var svgns = "http://www.w3.org/2000/svg";
    var strokew = "0.5";

    svg.addEventListener("mousedown", AlignmentMouseDown, false);
    svg.addEventListener("mousemove", AlignmentMouseMove, false);
    svg.addEventListener("mouseup", AlignmentMouseUp, false);
    svg.setAttributeNS(null, "onmousedown", "return false;"); //prevents marking

    while (svg.lastChild){
        svg.removeChild(svg.lastChild);
    }

    var delypos=20, delyshift=40;

    //bc, readsum:
    var SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("x", 40);
    SVGObj.setAttribute("y", ysize+delypos);
    SVGObj.setAttribute("font-size", "16");
    SVGObj.setAttribute("font-weight", "600");
    SVGObj.textContent = "SUMMARY: Gene: "+document.getElementsByName("GeneName")[0].value+"   |   File "+GetWellPos(barcode)+": "+files[barcode].name;
    svg.appendChild(SVGObj);
    delypos+=30;

    SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("x", 40);
    SVGObj.setAttribute("y", ysize+delypos);
    SVGObj.setAttribute("font-size", "16");
    SVGObj.textContent = "Total aligned reads: " + summary_track[barcode][7] +"   |  Outframe indel: " +summary_track[barcode][4]+ " READS, (" +(summary_track[barcode][4]*100/summary_track[barcode][7]).toFixed(2)+"%)" +"   |  Inframe indel: " +summary_track[barcode][3]+ " READS, (" +(summary_track[barcode][3]*100/summary_track[barcode][7]).toFixed(2)+"%)";
    svg.appendChild(SVGObj);
    delypos+=30;
    SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("x", 40);
    SVGObj.setAttribute("y", ysize+delypos);
    SVGObj.setAttribute("font-size", "16");
    SVGObj.textContent = "targetingOligo reads: " + summary_track[barcode][1] +"   |  No indel: " +summary_track[barcode][2] +" READS, (" +(summary_track[barcode][2]*100/summary_track[barcode][7]).toFixed(2)+"%)" +"   | Read ambigous: " +summary_track[barcode][5] //+"   | Not aligned to interested region: " +summary_track[barcode][6];
    svg.appendChild(SVGObj);

    delypos+=delyshift;

  // Legend RIMA2
    SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("y", ysize+delypos-70);
    SVGObj.setAttribute("font-size", "24");
    SVGObj.setAttribute("fill", N_cl);
    SVGObj.textContent = 'ANNOTATION';
    SVGObj.setAttribute("x", 120+6*(120));
    svg.appendChild(SVGObj);

    SVGObj= document.createElementNS(svgns, "rect");
    SVGObj.setAttribute("x", 120+6*(120));
    SVGObj.setAttribute("y", ysize+delypos-60);
    SVGObj.setAttribute("width", "11");
    SVGObj.setAttribute("height", "11");
    SVGObj.setAttribute("fill", "rgb(255,255,0");
    SVGObj.style.stroke=T_cl;
    SVGObj.setAttribute("pointer-events","none");
    svg.appendChild(SVGObj);
    SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("y", ysize+delypos-50);
    SVGObj.setAttribute("font-size", "14");
    SVGObj.setAttribute("fill", N_cl);
    SVGObj.textContent = 'DUPLICATED INSERTION';
    SVGObj.setAttribute("x", 120+6*120+30);
    svg.appendChild(SVGObj);

    SVGObj= document.createElementNS(svgns, "rect");
    SVGObj.setAttribute("x", 120+6*(120));
    SVGObj.setAttribute("y", ysize+delypos-40);
    SVGObj.setAttribute("width", "11");
    SVGObj.setAttribute("height", "11");
    SVGObj.setAttribute("fill", "rgb(0,255,255");
    SVGObj.setAttribute("text-anchor", "middle");
    SVGObj.setAttribute("pointer-events","none");
    svg.appendChild(SVGObj);
    SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("y", ysize+delypos-30);
    SVGObj.setAttribute("font-size", "14");
    SVGObj.setAttribute("fill", N_cl);
    SVGObj.textContent = 'MICRO HOMOLOGY';
    SVGObj.setAttribute("x", 120+6*120+30);
    svg.appendChild(SVGObj);

    SVGObj= document.createElementNS(svgns, "rect");
    SVGObj.setAttribute("x", 120+6*(120));
    SVGObj.setAttribute("y", ysize+delypos-20);
    SVGObj.setAttribute("width", "11");
    SVGObj.setAttribute("height", "11");
    SVGObj.setAttribute("fill", "rgb(255,255,255");
    SVGObj.setAttribute("text-anchor", "middle");
    SVGObj.style.stroke=T_cl;
    SVGObj.setAttribute("pointer-events","none");
    svg.appendChild(SVGObj);

    SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("y", ysize+delypos-10);
    SVGObj.setAttribute("font-size", "14");
    SVGObj.setAttribute("fill", N_cl);
    SVGObj.textContent = 'NORMAL SNP/INSERTION';
    SVGObj.setAttribute("x", 120+6*120+30);
    svg.appendChild(SVGObj);

    var xfrom = BreakPoint-30 +Math.floor(AlignmentStartPos);
    var xto = xfrom +60;
    //wt: REFERENCES SEQ
    for (let x=xfrom; x<xto; x++){
        //draw base:
        SVGObj= document.createElementNS(NS,"text");
        SVGObj.setAttribute("y", ysize+delypos+20);
        SVGObj.setAttribute("font-size", "14");
        if (x>=RightBsPos && x<RightBsPos+rightbs.length) SVGObj.setAttribute("fill", "rgb(0,0,250)");
        else SVGObj.setAttribute("fill", N_cl);
        SVGObj.textContent = locus[x];
        SVGObj.setAttribute("x", 120+12*(x-xfrom));
        SVGObj.setAttribute("text-anchor", "middle");
        svg.appendChild(SVGObj);
    }
    //sgRNA
    if (rightbs!=document.getElementsByName("RightBS")[0].value.replace(/[\s\n]+/g, '').toUpperCase()){
        var locus2 = ReverseString(ReverseComplement(locus))
    }
    else{
        var locus2 = locus
    }

    for (let x=RightBsPos; x<RightBsPos+rightbs.length; x++){
        //draw base:
        SVGObj= document.createElementNS(NS,"text");
        SVGObj.setAttribute("y", ysize+delypos);
        SVGObj.setAttribute("font-size", "14");
        SVGObj.setAttribute("fill", N_cl);
        SVGObj.textContent = locus2[x];
        SVGObj.setAttribute("x", 120+12*(x-xfrom));
        SVGObj.setAttribute("text-anchor", "middle");
        svg.appendChild(SVGObj);
    }
    
    var imageElement = document.createElementNS(NS, "image");
    if (rightbs!=document.getElementsByName("RightBS")[0].value.replace(/[\s\n]+/g, '').toUpperCase()){
        imageElement.setAttribute("x", 95+12*(RightBsPos-xfrom )); // Set the x-coordinate of the image
    }    
    else{
        imageElement.setAttribute("x", 120+12*(RightBsPos+rightbs.length-xfrom)+2); // Set the x-coordinate of the image
    }
    imageElement.setAttribute("y", ysize + delypos -20); // Set the y-coordinate of the image
    imageElement.setAttribute("width", 20); // Set the width of the image
    imageElement.setAttribute("height", 20); // Set the height of the image
    imageElement.setAttribute("href", "crisprnano2/scissors.svg"); // Set the path to your image file
    svg.appendChild(imageElement);

    //reference:
    SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("x", 5);
    SVGObj.setAttribute("y", ysize+delypos+20);
    SVGObj.setAttribute("font-size", "13");
    SVGObj.textContent += "REFERENCE 5'->3'";
    svg.appendChild(SVGObj);
    //line:
    SVGObj= document.createElementNS(NS,"path");
    SVGObj.setAttributeNS(null, "d", "M 5,"+(ysize+delypos+5.5)+" L 1200,"+(ysize+delypos+5.5));
    SVGObj.style.stroke=N_cl;
    SVGObj.setAttributeNS(null, "stroke-width", 1);
    svg.appendChild(SVGObj);
    delypos+=delyshift;
    var id1 = 1;

    for (let key in aln_dict_fil[barcode]){
        //aggregate WT
        var micro_homology_data = Check_RIMA(key)
        var duplication1 = Check_duplication(key)
        var rima_class = 'other EJ'
        if (micro_homology_data[0]!=''){
            rima_class = 'other EJ (MH-del 1bp)'
            if (micro_homology_data[0].length>=2){
                rima_class = 'MH-del'
            }
        }
        else if ((micro_homology_data[3]==1)||((micro_homology_data[1]!=-1)&&(micro_homology_data[2]-micro_homology_data[1]==1))){
            var rima_class = 'NHEJ'
        }
        else {
            rima_class = 'other EJ'
        }
         
        if (rima_class=='MH-del'||rima_class=='other EJ (MH-del 1bp)') { 
            for (let x=xfrom-70; x<xto+10; x++){
                if (((x >= micro_homology_data[1]-xfrom+10)&&(x < micro_homology_data[1]-xfrom+10 + micro_homology_data[0].length))||((x >= micro_homology_data[2]-xfrom+10)&&(x < micro_homology_data[2]-xfrom+10 + micro_homology_data[0].length))){
                    SVGObj= document.createElementNS(svgns, "rect");
                    SVGObj.setAttribute("x", 120+12*(x)-5);
                    SVGObj.setAttribute("y", ysize+delypos-10);
                    SVGObj.setAttribute("width", "11");
                    SVGObj.setAttribute("height", "11");
                    SVGObj.setAttribute("fill", "rgb(0,255,255");
                    SVGObj.setAttribute("text-anchor", "middle");
                    SVGObj.setAttribute("pointer-events","none");
                    svg.appendChild(SVGObj);
                }
            }
        }
        
        if (aln_dict[id][key][1]==1 && (Object.keys(no_indel_arr[barcode]).length ==2)){
            for (let x=xfrom-10; x<xto-10; x++){
            //draw main track:
            if (Object.keys(no_indel_arr[barcode])[0][x]==Object.keys(no_indel_arr[barcode])[1][x]){
                SVGObj= document.createElementNS(NS, "text");
                SVGObj.setAttribute("y", ysize+delypos);
                SVGObj.setAttribute("font-size", "13");
                SVGObj.setAttribute("font-weight", "400");
                if (key[x]=="T"){SVGObj.textContent = key[x];
                    SVGObj.setAttribute("fill", T_cl);
                }
                else if (key[x]=="A"){SVGObj.textContent = key[x];
                    SVGObj.setAttribute("fill", A_cl);
                }
                else if (key[x]=="C"){SVGObj.textContent = key[x];
                    SVGObj.setAttribute("fill", C_cl);
                }
                else if (key[x]=="G"){SVGObj.textContent = key[x];
                    SVGObj.setAttribute("fill", G_cl);
                }
                else if (key[x]=="N"){SVGObj.textContent = key[x];
                    SVGObj.setAttribute("fill", N_cl);
                }
                else if (key[x]=="-"){SVGObj.textContent = key[x];
                    SVGObj.setAttribute("fill", "rgb(0,0,0");
                }
                SVGObj.setAttribute("x", 120+12*(x-xfrom+10));
                SVGObj.setAttribute("text-anchor", "middle");
                SVGObj.setAttribute("pointer-events","none");
                svg.appendChild(SVGObj);
            }
            else {
                var fontsize1 = 2+ Math.floor(13*no_indel_arr[barcode][Object.keys(no_indel_arr[barcode])[0]]/(no_indel_arr[barcode][Object.keys(no_indel_arr[barcode])[0]]+no_indel_arr[barcode][Object.keys(no_indel_arr[barcode])[1]]))
                var fontsize2 = 2+ Math.floor(13*no_indel_arr[barcode][Object.keys(no_indel_arr[barcode])[1]]/(no_indel_arr[barcode][Object.keys(no_indel_arr[barcode])[0]]+no_indel_arr[barcode][Object.keys(no_indel_arr[barcode])[1]]))

                SVGObj= document.createElementNS(NS, "text");
                SVGObj.setAttribute("y", ysize+delypos+fontsize1-5);
                SVGObj.setAttribute("font-size", fontsize1);
                SVGObj.setAttribute("font-weight", "600");

                if (Object.keys(no_indel_arr[barcode])[0][x]=="T"){SVGObj.setAttribute("fill", T_cl);
                }
                else if (Object.keys(no_indel_arr[barcode])[0][x]=="A"){SVGObj.setAttribute("fill", A_cl);
                }
                else if (Object.keys(no_indel_arr[barcode])[0][x]=="C"){SVGObj.setAttribute("fill", C_cl);
                }
                else if (Object.keys(no_indel_arr[barcode])[0][x]=="G"){SVGObj.setAttribute("fill", G_cl);
                }
                else if (Object.keys(no_indel_arr[barcode])[0][x]=="N"){SVGObj.setAttribute("fill", N_cl);
                }
                else if (Object.keys(no_indel_arr[barcode])[0][x]=="-"){SVGObj.setAttribute("fill", N_cl);
                }
                SVGObj.textContent = Object.keys(no_indel_arr)[0][x];
                SVGObj.setAttribute("x", 120+12*(x-xfrom+10));
                SVGObj.setAttribute("text-anchor", "middle");
                SVGObj.setAttribute("pointer-events","none");
                svg.appendChild(SVGObj);

                SVGObj= document.createElementNS(NS, "text");
                SVGObj.setAttribute("y", ysize+delypos+15);
                SVGObj.setAttribute("font-size", 8);
                SVGObj.setAttribute("font-weight", "400");
                SVGObj.textContent = no_indel_arr[barcode][Object.keys(no_indel_arr[barcode])[1]] + " "+Object.keys(no_indel_arr[barcode])[1][x]
                SVGObj.setAttribute("x", 120+12*(x-xfrom+10));
                SVGObj.setAttribute("text-anchor", "middle");
                SVGObj.setAttribute("pointer-events","none");
                svg.appendChild(SVGObj);

                SVGObj= document.createElementNS(NS, "text");
                SVGObj.setAttribute("y", ysize+delypos+25);
                SVGObj.setAttribute("font-size", 8);
                SVGObj.setAttribute("font-weight", "400");
                SVGObj.textContent = no_indel_arr[barcode][Object.keys(no_indel_arr[barcode])[0]] + " " +Object.keys(no_indel_arr[barcode])[0][x]
                SVGObj.setAttribute("x", 120+12*(x-xfrom+10));
                SVGObj.setAttribute("text-anchor", "middle");
                SVGObj.setAttribute("pointer-events","none");
                svg.appendChild(SVGObj);

                SVGObj= document.createElementNS(NS, "text");
                SVGObj.setAttribute("y", ysize+delypos-5);
                SVGObj.setAttribute("font-size", fontsize2);
                SVGObj.setAttribute("font-weight", "600");

                if (Object.keys(no_indel_arr[barcode])[1][x]=="T"){SVGObj.setAttribute("fill", T_cl);
                }
                else if (Object.keys(no_indel_arr[barcode])[1][x]=="A"){SVGObj.setAttribute("fill", A_cl);
                }
                else if (Object.keys(no_indel_arr[barcode])[1][x]=="C"){SVGObj.setAttribute("fill", C_cl);
                }
                else if (Object.keys(no_indel_arr[barcode])[1][x]=="G"){SVGObj.setAttribute("fill", G_cl);
                }
                else if (Object.keys(no_indel_arr[barcode])[1][x]=="N"){SVGObj.setAttribute("fill", N_cl);
                }
                else if (Object.keys(no_indel_arr[barcode])[1][x]=="-"){SVGObj.setAttribute("fill", "rgb(0,0,0");
                }
                SVGObj.textContent = Object.keys(no_indel_arr[barcode])[1][x];
                SVGObj.setAttribute("x", 120+12*(x-xfrom+10));
                SVGObj.setAttribute("text-anchor", "middle");
                SVGObj.setAttribute("pointer-events","none");
                svg.appendChild(SVGObj);
            }
        }
        }
        else {
            for (let x=xfrom-10; x<xto-10; x++){
            //draw main track:
            if ((key[x]==locus[BreakPoint-region_analyse+x])||(key[x]=='N')||(key[x]=='-')||(typeof(key[x])=='undefined')){
                if ((duplication1[0])&&(x>=duplication1[1])&&(x<(duplication1[1]+duplication1[2]))){
                    SVGObj= document.createElementNS(svgns, "rect");
                    SVGObj.setAttribute("fill", "rgb(255,255,0");
                    SVGObj.style.stroke=T_cl;
                    SVGObj.setAttribute("x", 120+12*(x-xfrom+10)-5);
                    SVGObj.setAttribute("y", ysize+delypos-10);
                    SVGObj.setAttribute("width", "12");
                    SVGObj.setAttribute("height", "12");
                    SVGObj.setAttribute("text-anchor", "middle");
                    SVGObj.setAttribute("pointer-events","none");
                    svg.appendChild(SVGObj);
                    }
                SVGObj= document.createElementNS(NS, "text");
                SVGObj.setAttribute("font-weight", "400");
            }
            else {
                SVGObj= document.createElementNS(svgns, "rect");
                SVGObj.style.stroke=N_cl;
                SVGObj.setAttribute("x", 115+12*(x-xfrom+10));
                SVGObj.setAttribute("y", ysize+delypos-10);
                SVGObj.setAttribute("width", "11");
                SVGObj.setAttribute("height", "11");
                SVGObj.setAttribute("fill", "rgb(255,255,255");
                SVGObj.setAttribute("text-anchor", "middle");
                SVGObj.setAttribute("pointer-events","none");
                svg.appendChild(SVGObj);
                SVGObj= document.createElementNS(NS, "text");
                SVGObj.setAttribute("font-weight", "600");
            }
            
            SVGObj.setAttribute("y", ysize+delypos);
            SVGObj.setAttribute("font-size", "13");

            if (key[x]=="T"){SVGObj.textContent = key[x];
                SVGObj.setAttribute("fill", T_cl);
            }
            else if (key[x]=="A"){SVGObj.textContent = key[x];
                SVGObj.setAttribute("fill", A_cl);
            }
            else if (key[x]=="C"){SVGObj.textContent = key[x];
                SVGObj.setAttribute("fill", C_cl);
            }
            else if (key[x]=="G"){SVGObj.textContent = key[x];
                SVGObj.setAttribute("fill", G_cl);
            }
            else if (key[x]=="N"){SVGObj.textContent = key[x];
                SVGObj.setAttribute("fill", N_cl);
            }
            else if (key[x]=="-"){SVGObj.textContent = key[x];
                SVGObj.setAttribute("fill", N_cl);
            }
            SVGObj.setAttribute("x", 120+12*(x-xfrom+10));
            SVGObj.setAttribute("text-anchor", "middle");
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj); 
            }
        }
        
        var image_loc = 0;
        for (let x=xfrom-10; x<xto-10; x++){
            if (x>0){
            //draw insert:
            SVGObj= document.createElementNS(svgns, "rect");
            // if ((key[x+region_analyse*2]!="\xa0")&&(key[x+region_analyse*2]!="\n")){
            if ('ACTG'.includes(key[x+region_analyse*2])){
                if (image_loc == 0){
                    var imageElement = document.createElementNS(NS, "image");
                    imageElement.setAttribute("x", 120+12*(x-xfrom+10)-16); // Set the x-coordinate of the image

                    imageElement.setAttribute("y", ysize+delypos+4); // Set the y-coordinate of the image
                    imageElement.setAttribute("width", 12); // Set the width of the image
                    imageElement.setAttribute("height", 12); // Set the height of the image
                    imageElement.setAttribute("href", "crisprnano2/insert.svg"); // Set the path to your image file
                    svg.appendChild(imageElement);
                    image_loc =1;
                }
                if (duplication1[0]){
                    SVGObj.setAttribute("fill", "rgb(255,255,0");
                }
                else{
                    SVGObj.setAttribute("fill", "rgb(255,255,255");
                }
                SVGObj.style.stroke=T_cl;
                SVGObj.setAttribute("x", 120+12*(x-xfrom+10));
                SVGObj.setAttribute("y", ysize+delypos+4);
                SVGObj.setAttribute("width", "12");
                SVGObj.setAttribute("height", "12");
                SVGObj.setAttribute("text-anchor", "middle");
                SVGObj.setAttribute("pointer-events","none");
                svg.appendChild(SVGObj);
            }

            SVGObj= document.createElementNS(NS,"text");
            SVGObj.setAttribute("x", 120+12*(x-xfrom+10)+5);
            SVGObj.setAttribute("y", ysize+delypos+15);
            SVGObj.setAttribute("font-size", "13");
            SVGObj.setAttribute("fill", N_cl);
            SVGObj.textContent = key[x+region_analyse*2];
            SVGObj.setAttribute("text-anchor", "middle");
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);
            }
        }
        
        SVGObj= document.createElementNS(NS,"text");
        SVGObj.setAttribute("x", 5);
        SVGObj.setAttribute("y", ysize+delypos);
        SVGObj.setAttribute("font-size", "14");
        SVGObj.textContent += "GROUP " +id1;
        svg.appendChild(SVGObj);

        SVGObj= document.createElementNS(NS,"text");
        SVGObj.setAttribute("x", 10+ 120+24*(30)+2 );
        SVGObj.setAttribute("y", ysize+delypos);
        SVGObj.setAttribute("font-size", "14");
        // Count INDEL's length
        var gap_len1 = (key.substring(region_analyse*2 +1, region_analyse*4).split("G").length-1) +(key.substring(region_analyse*2 +1, region_analyse*4).split("A").length-1) +(key.substring(region_analyse*2 +1, region_analyse*4).split("T").length-1) +(key.substring(region_analyse*2 +1, region_analyse*4).split("C").length-1) - (key.split("-").length-1);

        SVGObj.textContent +="TYPE: "+ aln_type[aln_dict[barcode][key][1]] + ", (" + gap_len1 + " bp)" +" | " +aln_dict_fil[barcode][key] +"  Reads, " + (aln_dict_fil[barcode][key]/summary_track[barcode][7]*100).toFixed(2) + " %";
        svg.appendChild(SVGObj);

        SVGObj= document.createElementNS(NS,"text");
        SVGObj.setAttribute("x", 10+ 120+24*(30)+2 );
        SVGObj.setAttribute("y", ysize+delypos+13);
        SVGObj.setAttribute("font-size", "14");
        if (rima_class == 'NHEJ'){
            SVGObj.setAttribute("fill", "rgb(17, 94, 94)");
        }
        else if (rima_class == 'other EJ'){
            SVGObj.setAttribute("fill", "rgb(153, 151, 151)");
        }
        else if (rima_class == 'MH-del'){
            SVGObj.setAttribute("fill", "rgb(84, 199, 199)");
        }

        SVGObj.textContent +="RIMA classified as: "+ rima_class;
        svg.appendChild(SVGObj);

        id1+=1;
        delypos+=delyshift;
    }
    AlignmentPrecalc[barcode] = document.getElementById("DIV_alignment").innerHTML;
}

function PlotAlignment_bulk(barcode, locus, bulk_threshold){
    //compute number of aligned read
    // check genotype
    var id = barcode;
    aln_dict_bulk = {}

    for (let key in aln_dict[id]){
        if ((aln_dict[id][key][1]!=8)&&(aln_dict[id][key]>10)&&(aln_dict[id][key]>(1*bulk_threshold*summary_track[id][0]/100))&&(key.split('\n')[0].trim().length>region_analyse*2-4)){
            aln_dict_bulk[key] = aln_dict[id][key];
        }
    }
    
    var no_indel = 0; 
    var no_indel_arr = []
    var inf_indel =  0;
    var out_indel = 0;
    var out_indel_arr = []
    var sum = 0;
    var targetingOligo = 0;
    var targetingOligo_arr = [];

    for (let key in aln_dict_bulk){
        switch (aln_dict[id][key][1]){
            case 1:
                no_indel+=aln_dict_bulk[key];
                no_indel_arr[key] = aln_dict_bulk[key];
                break;
            case 2:
                inf_indel+=aln_dict_bulk[key];
                break;
            case 3: 
                out_indel+=aln_dict_bulk[key];
                out_indel_arr.push(aln_dict_bulk[key])
                break;
            case 7: 
                targetingOligo+=aln_dict_bulk[key];
                targetingOligo_arr.push(aln_dict_bulk[key])
                break;
        }
    }
    
    //update new WT candidate, keep maximum
    if (Object.keys(no_indel_arr).length >1){
        let maxValue = -Infinity;
            var sum_wt = 0;
            var candidate_wt;
            for (const key1 in no_indel_arr) {
                const value = no_indel_arr[key1];
                if (value > maxValue) {
                maxValue = value;
                candidate_wt = key1;
                }
                sum_wt += value;
                delete aln_dict_bulk[key1];
            }
            //update new candidate WT (max)
            aln_dict_bulk[candidate_wt] = sum_wt;
    }

    // For saving csv
    summary_track[id][1] = targetingOligo;
    summary_track[id][2] = no_indel;
    summary_track[id][3] = inf_indel;
    summary_track[id][4] = out_indel;
    summary_track[id][7] = no_indel+inf_indel+out_indel+targetingOligo;
    if (summary_track[id][7]>0) {
        summary_track_select[id+1] =  [GetWellPos(id), (targetingOligo/summary_track[id][7]*100).toFixed(2), (no_indel/summary_track[id][7]*100).toFixed(2), (inf_indel/summary_track[id][7]*100).toFixed(2), (out_indel/summary_track[id][7]*100).toFixed(2), summary_track[id][7]]
    }
    else {
        summary_track_select[id+1] =  [GetWellPos(id), targetingOligo, no_indel, inf_indel, out_indel, summary_track[id][7]]

    }

    // sort aligment tract
    var items = Object.keys(aln_dict_bulk).map(function(key) {
    return [key, aln_dict_bulk[key]];
    });
    // Sort the array based on the second element
    items.sort(function(first, second) {
    return second[1] - first[1];
    });
    aln_dict_bulk = Object.fromEntries(items.map(([v, k]) => [v, k]));

    //aggregate aln_track
    //Find top 3:
    var aln_type = ["Not align","No indel", "Inframe Indel", "Outframe indel", "", "","", "targetingOligo", "Ambigious"]
    var ysize = 30;
    var max=0;
    
    var svg = document.getElementById("SVGmut_bulk");
    var NS="http://www.w3.org/2000/svg";
    var svgns = "http://www.w3.org/2000/svg";
    var strokew = "0.5";

    svg.addEventListener("mousedown", AlignmentMouseDown, false);
    svg.addEventListener("mousemove", AlignmentMouseMove_bulk, false);
    svg.addEventListener("mouseup", AlignmentMouseUp, false);
    svg.setAttributeNS(null, "onmousedown", "return false;"); //prevents marking

    while (svg.lastChild){
        svg.removeChild(svg.lastChild);
    }

    var delypos=20, delyshift=40;

    //bc, readsum:
    var SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("x", 40);
    SVGObj.setAttribute("y", ysize+delypos);
    SVGObj.setAttribute("font-size", "16");
    SVGObj.setAttribute("font-weight", "600");
    SVGObj.textContent = "SUMMARY: Gene: "+document.getElementsByName("GeneName")[0].value+"   |   File "+GetWellPos(barcode)+": "+files[barcode].name;
    svg.appendChild(SVGObj);
    delypos+=30;

    SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("x", 40);
    SVGObj.setAttribute("y", ysize+delypos);
    SVGObj.setAttribute("font-size", "16");
    SVGObj.textContent = "Total aligned reads: " + summary_track[barcode][7] +"   |  Outframe indel: " +summary_track[barcode][4]+ " READS, (" +(summary_track[barcode][4]*100/summary_track[barcode][7]).toFixed(2)+"%)" +"   |  Inframe indel: " +summary_track[barcode][3]+ " READS, (" +(summary_track[barcode][3]*100/summary_track[barcode][7]).toFixed(2)+"%)";
    svg.appendChild(SVGObj);
    delypos+=30;
    SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("x", 40);
    SVGObj.setAttribute("y", ysize+delypos);
    SVGObj.setAttribute("font-size", "16");
    SVGObj.textContent = "targetingOligo reads: " + summary_track[barcode][1] +"   |  No indel: " +summary_track[barcode][2] +" READS, (" +(summary_track[barcode][2]*100/summary_track[barcode][7]).toFixed(2)+"%)" +"   | Read ambigous: " +summary_track[barcode][5] //+"   | Not aligned to interested region: " +summary_track[barcode][6];
    svg.appendChild(SVGObj);

    delypos+=delyshift;

    var xfrom = BreakPoint-30 +Math.floor(AlignmentStartPos);
    var xto = xfrom +60;
    //wt: REFERENCES SEQ
    for (let x=xfrom; x<xto; x++){
        //draw base:
        SVGObj= document.createElementNS(NS,"text");
        SVGObj.setAttribute("y", ysize+delypos+20);
        SVGObj.setAttribute("font-size", "14");
        if (x>=RightBsPos && x<RightBsPos+rightbs.length) SVGObj.setAttribute("fill", "rgb(0,0,250)");
        else SVGObj.setAttribute("fill", "rgb(0,0,0)");
        SVGObj.textContent = locus[x];
        SVGObj.setAttribute("x", 120+12*(x-xfrom));
        SVGObj.setAttribute("text-anchor", "middle");
        svg.appendChild(SVGObj);
    }
    //sgRNA
    if (rightbs!=document.getElementsByName("RightBS")[0].value.replace(/[\s\n]+/g, '').toUpperCase()){
        var locus2 = ReverseString(ReverseComplement(locus))
    }
    else{
        var locus2 = locus
    }

    for (let x=RightBsPos; x<RightBsPos+rightbs.length; x++){
        //draw base:
        SVGObj= document.createElementNS(NS,"text");
        SVGObj.setAttribute("y", ysize+delypos);
        SVGObj.setAttribute("font-size", "14");
        SVGObj.setAttribute("fill", "rgb(0,0,0)");
        SVGObj.textContent = locus2[x];
        SVGObj.setAttribute("x", 120+12*(x-xfrom));
        SVGObj.setAttribute("text-anchor", "middle");
        svg.appendChild(SVGObj);
    }
    
    var imageElement = document.createElementNS(NS, "image");
    if (rightbs!=document.getElementsByName("RightBS")[0].value.replace(/[\s\n]+/g, '').toUpperCase()){
        imageElement.setAttribute("x", 95+12*(RightBsPos-xfrom )); // Set the x-coordinate of the image
    }    
    else{
        imageElement.setAttribute("x", 120+12*(RightBsPos+rightbs.length-xfrom)+2); // Set the x-coordinate of the image
    }
    imageElement.setAttribute("y", ysize + delypos -20); // Set the y-coordinate of the image
    imageElement.setAttribute("width", 20); // Set the width of the image
    imageElement.setAttribute("height", 20); // Set the height of the image
    imageElement.setAttribute("href", "https://crisprnano.de/crisprnano2/scissors.svg"); // Set the path to your image file
    svg.appendChild(imageElement);

    //reference:
    SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("x", 5);
    SVGObj.setAttribute("y", ysize+delypos+20);
    SVGObj.setAttribute("font-size", "13");
    SVGObj.textContent += "REFERENCE 5'->3'";
    svg.appendChild(SVGObj);
    //line:
    SVGObj= document.createElementNS(NS,"path");
    SVGObj.setAttributeNS(null, "d", "M 5,"+(ysize+delypos+5.5)+" L 1200,"+(ysize+delypos+5.5));
    SVGObj.style.stroke="rgb(0,0,0)";
    SVGObj.setAttributeNS(null, "stroke-width", 1);
    svg.appendChild(SVGObj);
    delypos+=delyshift;
    var id1 = 1;

    //for indel plot
    var indel_info = []
    var indel_info_dist = []
    indel_info_hist = []

    for (let key in aln_dict_bulk){
        //aggregate WT
        for (let x=0; x<30*2; x++){
            //draw main track:
            if ((key[x]==locus[BreakPoint-region_analyse+x])||(key[x]=='N')||(key[x]=='-')||(typeof(key[x])=='undefined')){
                SVGObj= document.createElementNS(svgns, "rect");
                SVGObj.setAttribute("x", 120+12*(x)-5);
                SVGObj.setAttribute("y", ysize+delypos-10);
                SVGObj.setAttribute("width", "11");
                SVGObj.setAttribute("height", "11");
                SVGObj.setAttribute("fill", "rgb(216,216,216");
                SVGObj.setAttribute("text-anchor", "middle");
                SVGObj.setAttribute("pointer-events","none");
                svg.appendChild(SVGObj);
                }
            }

        if (aln_dict[id][key][1]==1 && (Object.keys(no_indel_arr).length ==2)){
            for (let x=xfrom-10; x<xto-10; x++){
            //draw main track:
            if (Object.keys(no_indel_arr)[0][x]==Object.keys(no_indel_arr)[1][x]){
                if ((Object.keys(no_indel_arr)[0][x]==locus[BreakPoint-region_analyse+x])||(key[x]=='N')||(key[x]=='-')||(typeof(key[x])=='undefined')){
                }
                else {
                    SVGObj= document.createElementNS(svgns, "rect");
                    SVGObj.style.stroke="rgb(0,0,0)";
                    SVGObj.setAttribute("x", 115+12*(x-xfrom+10));
                    SVGObj.setAttribute("y", ysize+delypos-10);
                    SVGObj.setAttribute("width", "11");
                    SVGObj.setAttribute("height", "11");
                    SVGObj.setAttribute("fill", "rgb(216,216,216");
                    SVGObj.setAttribute("text-anchor", "middle");
                    SVGObj.setAttribute("pointer-events","none");
                    svg.appendChild(SVGObj);
                }
                SVGObj= document.createElementNS(NS, "text");
                    SVGObj.setAttribute("y", ysize+delypos);
                    SVGObj.setAttribute("font-size", "13");
                    SVGObj.setAttribute("font-weight", "400");
                    if (key[x]=="T"){SVGObj.textContent = key[x];
                        SVGObj.setAttribute("fill", "rgb(255,0,0");
                    }
                    else if (key[x]=="A"){SVGObj.textContent = key[x];
                        SVGObj.setAttribute("fill", "rgb(0,150,0");
                    }
                    else if (key[x]=="C"){SVGObj.textContent = key[x];
                        SVGObj.setAttribute("fill", "rgb(0,0,255");
                    }
                    else if (key[x]=="G"){SVGObj.textContent = key[x];
                        SVGObj.setAttribute("fill", "rgb(200, 100, 0");
                    }
                    else if (key[x]=="N"){SVGObj.textContent = key[x];
                        SVGObj.setAttribute("fill", "rgb(0, 0, 0");
                    }
                    else if (key[x]=="-"){SVGObj.textContent = key[x];
                        SVGObj.setAttribute("fill", "rgb(0,0,0");
                    }
                    SVGObj.setAttribute("x", 120+12*(x-xfrom+10));
                    SVGObj.setAttribute("text-anchor", "middle");
                    SVGObj.setAttribute("pointer-events","none");
                    svg.appendChild(SVGObj);
            }
            else {
                var fontsize1 = 2+ Math.floor(13*no_indel_arr[Object.keys(no_indel_arr)[0]]/(no_indel_arr[Object.keys(no_indel_arr)[0]]+no_indel_arr[Object.keys(no_indel_arr)[1]]))
                var fontsize2 = 2+ Math.floor(13*no_indel_arr[Object.keys(no_indel_arr)[1]]/(no_indel_arr[Object.keys(no_indel_arr)[0]]+no_indel_arr[Object.keys(no_indel_arr)[1]]))

                SVGObj= document.createElementNS(NS, "text");
                SVGObj.setAttribute("y", ysize+delypos+fontsize1-5);
                SVGObj.setAttribute("font-size", fontsize1);
                SVGObj.setAttribute("font-weight", "600");

                if (Object.keys(no_indel_arr)[0][x]=="T"){SVGObj.setAttribute("fill", "rgb(255,0,0");
                }
                else if (Object.keys(no_indel_arr)[0][x]=="A"){SVGObj.setAttribute("fill", "rgb(0,150,0");
                }
                else if (Object.keys(no_indel_arr)[0][x]=="C"){SVGObj.setAttribute("fill", "rgb(0,0,255");
                }
                else if (Object.keys(no_indel_arr)[0][x]=="G"){SVGObj.setAttribute("fill", "rgb(200, 100, 0");
                }
                else if (Object.keys(no_indel_arr)[0][x]=="N"){SVGObj.setAttribute("fill", "rgb(0, 0, 0");
                }
                else if (Object.keys(no_indel_arr)[0][x]=="-"){SVGObj.setAttribute("fill", "rgb(0,0,0");
                }
                SVGObj.textContent = Object.keys(no_indel_arr)[0][x];
                SVGObj.setAttribute("x", 120+12*(x-xfrom+10));
                SVGObj.setAttribute("text-anchor", "middle");
                SVGObj.setAttribute("pointer-events","none");
                svg.appendChild(SVGObj);

                SVGObj= document.createElementNS(NS, "text");
                SVGObj.setAttribute("y", ysize+delypos+15);
                SVGObj.setAttribute("font-size", 8);
                SVGObj.setAttribute("font-weight", "400");
                SVGObj.textContent = no_indel_arr[Object.keys(no_indel_arr)[1]] + " "+Object.keys(no_indel_arr)[1][x]
                SVGObj.setAttribute("x", 120+12*(x-xfrom+10));
                SVGObj.setAttribute("text-anchor", "middle");
                SVGObj.setAttribute("pointer-events","none");
                svg.appendChild(SVGObj);

                SVGObj= document.createElementNS(NS, "text");
                SVGObj.setAttribute("y", ysize+delypos+25);
                SVGObj.setAttribute("font-size", 8);
                SVGObj.setAttribute("font-weight", "400");
                SVGObj.textContent = no_indel_arr[Object.keys(no_indel_arr)[0]] + " " +Object.keys(no_indel_arr)[0][x]
                SVGObj.setAttribute("x", 120+12*(x-xfrom+10));
                SVGObj.setAttribute("text-anchor", "middle");
                SVGObj.setAttribute("pointer-events","none");
                svg.appendChild(SVGObj);

                SVGObj= document.createElementNS(NS, "text");
                SVGObj.setAttribute("y", ysize+delypos-5);
                SVGObj.setAttribute("font-size", fontsize2);
                SVGObj.setAttribute("font-weight", "600");

                if (Object.keys(no_indel_arr)[1][x]=="T"){SVGObj.setAttribute("fill", "rgb(255,0,0");
                }
                else if (Object.keys(no_indel_arr)[1][x]=="A"){SVGObj.setAttribute("fill", "rgb(0,150,0");
                }
                else if (Object.keys(no_indel_arr)[1][x]=="C"){SVGObj.setAttribute("fill", "rgb(0,0,255");
                }
                else if (Object.keys(no_indel_arr)[1][x]=="G"){SVGObj.setAttribute("fill", "rgb(200, 100, 0");
                }
                else if (Object.keys(no_indel_arr)[1][x]=="N"){SVGObj.setAttribute("fill", "rgb(0, 0, 0");
                }
                else if (Object.keys(no_indel_arr)[1][x]=="-"){SVGObj.setAttribute("fill", "rgb(0,0,0");
                }
                SVGObj.textContent = Object.keys(no_indel_arr)[1][x];
                SVGObj.setAttribute("x", 120+12*(x-xfrom+10));
                SVGObj.setAttribute("text-anchor", "middle");
                SVGObj.setAttribute("pointer-events","none");
                svg.appendChild(SVGObj);
            }
        }
        }
        else {
            for (let x=xfrom-10; x<xto-10; x++){
            //draw main track:
            if ((key[x]==locus[BreakPoint-region_analyse+x])||(key[x]=='N')||(key[x]=='-')||(typeof(key[x])=='undefined')){
                SVGObj= document.createElementNS(NS, "text");
                SVGObj.setAttribute("font-weight", "400");
            }
            else {
                SVGObj= document.createElementNS(svgns, "rect");
                SVGObj.style.stroke="rgb(0,0,0)";
                SVGObj.setAttribute("x", 115+12*(x-xfrom+10));
                SVGObj.setAttribute("y", ysize+delypos-10);
                SVGObj.setAttribute("width", "11");
                SVGObj.setAttribute("height", "11");
                SVGObj.setAttribute("fill", "rgb(216,216,216");
                SVGObj.setAttribute("text-anchor", "middle");
                SVGObj.setAttribute("pointer-events","none");
                svg.appendChild(SVGObj);
                SVGObj= document.createElementNS(NS, "text");
                SVGObj.setAttribute("font-weight", "600");

            }
            
            SVGObj.setAttribute("y", ysize+delypos);
            SVGObj.setAttribute("font-size", "13");

            if (key[x]=="T"){SVGObj.textContent = key[x];
                SVGObj.setAttribute("fill", "rgb(255,0,0");
            }
            else if (key[x]=="A"){SVGObj.textContent = key[x];
                SVGObj.setAttribute("fill", "rgb(0,150,0");
            }
            else if (key[x]=="C"){SVGObj.textContent = key[x];
                SVGObj.setAttribute("fill", "rgb(0,0,255");
            }
            else if (key[x]=="G"){SVGObj.textContent = key[x];
                SVGObj.setAttribute("fill", "rgb(200, 100, 0");
            }
            else if (key[x]=="N"){SVGObj.textContent = key[x];
                SVGObj.setAttribute("fill", "rgb(0, 0, 0");
            }
            else if (key[x]=="-"){SVGObj.textContent = key[x];
                SVGObj.setAttribute("fill", "rgb(0,0,0");
            }
            SVGObj.setAttribute("x", 120+12*(x-xfrom+10));
            SVGObj.setAttribute("text-anchor", "middle");
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj); 
            }
        }
        
        var image_loc = 0;
        for (let x=xfrom-10; x<xto-10; x++){
            if (x>0){
            //draw insert:
            SVGObj= document.createElementNS(svgns, "rect");
            // if ((key[x+region_analyse*2]!="\xa0")&&(key[x+region_analyse*2]!="\n")){
            if ('ACTG'.includes(key[x+region_analyse*2])){
                if (image_loc == 0){
                    var imageElement = document.createElementNS(NS, "image");
                    imageElement.setAttribute("x", 120+12*(x-xfrom+10)-16); // Set the x-coordinate of the image
                        
                    imageElement.setAttribute("y", ysize+delypos+4); // Set the y-coordinate of the image
                    imageElement.setAttribute("width", 12); // Set the width of the image
                    imageElement.setAttribute("height", 12); // Set the height of the image
                    imageElement.setAttribute("href", "https://crisprnano.de/crisprnano2/insert.svg"); // Set the path to your image file
                    svg.appendChild(imageElement);
                    image_loc =1;
                }
                SVGObj.style.stroke="rgb(255,0,0)";
                SVGObj.setAttribute("x", 120+12*(x-xfrom+10));
                SVGObj.setAttribute("y", ysize+delypos+4);
                SVGObj.setAttribute("width", "12");
                SVGObj.setAttribute("height", "12");
                SVGObj.setAttribute("fill", "rgb(255,255,255");
                SVGObj.setAttribute("text-anchor", "middle");
                SVGObj.setAttribute("pointer-events","none");
                svg.appendChild(SVGObj);
            }

            SVGObj= document.createElementNS(NS,"text");
            SVGObj.setAttribute("x", 120+12*(x-xfrom+10)+5);
            SVGObj.setAttribute("y", ysize+delypos+15);
            SVGObj.setAttribute("font-size", "13");
            SVGObj.setAttribute("fill", "rgb(0,0,0)");
            SVGObj.textContent = key[x+region_analyse*2];
            SVGObj.setAttribute("text-anchor", "middle");
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);
            }
        }
        
        SVGObj= document.createElementNS(NS,"text");
        SVGObj.setAttribute("x", 5);
        SVGObj.setAttribute("y", ysize+delypos);
        SVGObj.setAttribute("font-size", "14");
        SVGObj.textContent += "GROUP " +id1;
        svg.appendChild(SVGObj);

        SVGObj= document.createElementNS(NS,"text");
        SVGObj.setAttribute("x", 10+ 120+24*(30)+2 );
        SVGObj.setAttribute("y", ysize+delypos);
        SVGObj.setAttribute("font-size", "14");
        // Count INDEL's length
        var gap_len1 = (key.substring(region_analyse*2 +1, region_analyse*4).split("G").length-1) +(key.substring(region_analyse*2 +1, region_analyse*4).split("A").length-1) +(key.substring(region_analyse*2 +1, region_analyse*4).split("T").length-1) +(key.substring(region_analyse*2 +1, region_analyse*4).split("C").length-1) - (key.split("-").length-1);

        SVGObj.textContent +="TYPE: "+ aln_type[aln_dict[barcode][key][1]] + ", (" + gap_len1 + " bp)" +" | " +aln_dict_bulk[key] +"  Reads, " + (aln_dict_bulk[key]/summary_track[barcode][7]*100).toFixed(2) + " %";
        
        if (gap_len1*1<0){
            loc_indel = key.search('-') - BreakPoint;
            if (rightbs!=document.getElementsByName("RightBS")[0].value.replace(/[\s\n]+/g, '').toUpperCase()){
                indel_info.push([gap_len1, loc_indel + rightbs.length])
                indel_info_dist.push([aln_dict_bulk[key], loc_indel + rightbs.length])
                indel_info_hist.push([gap_len1, loc_indel + rightbs.length, aln_dict_bulk[key]/summary_track[barcode][7]*100, aln_dict_bulk[key]])

            }
            else {
                indel_info.push([gap_len1, loc_indel])
                indel_info_dist.push([aln_dict_bulk[key], loc_indel])
                indel_info_hist.push([gap_len1, loc_indel, aln_dict_bulk[key]/summary_track[barcode][7]*100, aln_dict_bulk[key]])
            }
        } 
        else if (gap_len1*1>0){
            var ins_str = key.split('\n')[1]
            var tmp_ins = -1000
            for (let i = 0; i < ins_str.length; i++) {
                if ("ACTG".includes(ins_str[i])&&tmp_ins==-1000) {
                    loc_indel = i - BreakPoint
                    tmp_ins = 1
                    if (rightbs!=document.getElementsByName("RightBS")[0].value.replace(/[\s\n]+/g, '').toUpperCase()){
                        indel_info.push([gap_len1, loc_indel + rightbs.length])
                        indel_info_dist.push([aln_dict_bulk[key], loc_indel+ rightbs.length])
                        indel_info_hist.push([gap_len1, loc_indel + rightbs.length, aln_dict_bulk[key]/summary_track[barcode][7]*100, aln_dict_bulk[key]])
                        }
                        else {
                            indel_info.push([gap_len1, loc_indel])
                            indel_info_dist.push([aln_dict_bulk[key]])
                            indel_info_hist.push([gap_len1, loc_indel, aln_dict_bulk[key]/summary_track[barcode][7]*100, aln_dict_bulk[key]])
                        }
                }
            }
        }
        svg.appendChild(SVGObj);
        id1+=1;
        delypos+=delyshift;
    }
    AlignmentPrecalc_bulk = document.getElementById("DIV_alignment_bulk").innerHTML;

    if (indel_info.length !=0){
        const uniqueArray = indel_info.filter((arr, index, self) => 
            index === self.findIndex((a) => 
                a.toString() === arr.toString()
            )
        );
        indel_info= uniqueArray
        // Set layout
        const transposedData = indel_info[0].map((col, i) => indel_info.map(row => row[i]));
        var xValues = transposedData[1];
        var yValues = transposedData[0];

    }
    else {
        var xValues = [];
        var yValues = [];
    }

      // Separate positive and negative values
    const positiveX = [];
    const positiveY = [];
    const negativeX = [];
    const negativeY = [];

    for (let i = 0; i < yValues.length; i++) {
        if (yValues[i] >= 0) {
        positiveX.push(xValues[i]);
        positiveY.push(yValues[i]);
        } else {
        negativeX.push(xValues[i]);
        negativeY.push(yValues[i]);
        }
    }

      // Creating traces for positive and negative values
        const tracePositive = {
            x: positiveX,
            y: positiveY,
            type: 'bar',
            marker: {
            color: 'blue'
            },
            name: 'INSERTION',
            text: positiveX.map((xVal, index) => `Indel Loc: ${xVal}, Indel Size: ${positiveY[index]}`), // Display x and y values on positive bars
            textposition: 'auto'
        };

        const traceNegative = {
            x: negativeX,
            y: negativeY,
            type: 'bar',
            marker: {
            color: 'orange'
            },
            name: 'DELETION',
            text: negativeX.map((xVal, index) => `Indel Loc: ${xVal}, Indel Size: ${negativeY[index]}`), // Display x and y values on negative bars
            textposition: 'auto'
        };

        const layout = {
        title: 'Indel Size and Location',
        xaxis: {
        title: 'Indel Size and Location',
        range: [-80, 80]
        },
        yaxis: {
        title: 'Indel size (bp)'
        },
        legend: {
        x: 1,
        xanchor: 'left',
        y: 1,
        showlegend: true
        }
    };

    // Plot
    Plotly.newPlot('Indel_plot', [tracePositive, traceNegative], layout);
}

//Alignment summary plot:
function PlotAlignment_off(gene_i)
{
    var id = gene_i;
    var barcode = gene_i;
    for (let key in aln_dict_off[id]){
        sum_track_off[id] += aln_dict_off[id][key];
    }
 
    var sum = 0;
    var read_ambigous =0;
    // var targetingOligo = 0;
    //!TODO: Change to read length
    for (var i=0; i<hits[id].length; i++){
        if (hits_off[id][i]>=0){
            switch (hits_off[id][i]){
                case 1:
                    sum++
                    break;
                case 2:
                    sum++
                    break;
                case 3: 
                    sum++
                    break;
                case 7: 
                    // targetingOligo++;
                    sum++
                    break;
                case 8: 
                    read_ambigous++;
                //     sum++
                //     break;
            }
        }
    }

    summary_track_off[id][0] = sum + read_ambigous;
    summary_track_off[id][5] = read_ambigous;
    summary_track_off[id][7] = sum;
    
    for (let key in aln_dict_off[id]){
        if ((aln_type_dict_off[id][key]!=8)&&(aln_dict_off[id][key]>10)&&(aln_dict_off[id][key]>(1*summary_track_off[id][7]/100))&&(key.split('\n')[0].trim().length>region_analyse*2-4)){
            aln_dict_fil_off[id][key] = aln_dict_off[id][key];
        }
    }
    
    var no_indel = 0; 
    var no_indel_arr = []
    var inf_indel =  0;
    var out_indel = 0;
    var out_indel_arr = []
    var sum = 0;

    for (let key in aln_dict_fil_off[id]){
        switch (aln_type_dict_off[id][key]){
            case 1:
                no_indel+=aln_dict_fil_off[id][key];
                no_indel_arr[key] = aln_dict_fil_off[id][key];
                break;
            case 2:
                inf_indel+=aln_dict_fil_off[id][key];
                break;
            case 3: 
                out_indel+=aln_dict_fil_off[id][key];
                out_indel_arr.push(aln_dict_fil_off[id][key])
                break;
        }
    }
    
    //update new WT candidate, keep maximum
    if (Object.keys(no_indel_arr).length >1){
        let maxValue = -Infinity;
            var sum_wt = 0;
            var candidate_wt;
            for (const key1 in no_indel_arr) {
                const value = no_indel_arr[key1];
                if (value > maxValue) {
                maxValue = value;
                candidate_wt = key1;
                }
                sum_wt += value;
                delete aln_dict_fil_off[id][key1];
            }
            //update new candidate WT (max)
            aln_dict_fil_off[id][candidate_wt] = sum_wt;
    }

        // For saving csv
    summary_track_off[id][2] = no_indel;
    summary_track_off[id][3] = inf_indel;
    summary_track_off[id][4] = out_indel;
    summary_track_off[id][7] = no_indel+inf_indel+out_indel;

    // sort aligment tract
    var items = Object.keys(aln_dict_fil_off[id]).map(function(key) {
    return [key, aln_dict_fil_off[id][key]];
    });
    // Sort the array based on the second element
    items.sort(function(first, second) {
    return second[1] - first[1];
    });
    aln_dict_fil_off[id] = Object.fromEntries(items.map(([v, k]) => [v, k]));

    //aggregate aln_track
    //Find top 3:
    var aln_type = ["Not align","No indel", "Inframe Indel", "Outframe indel", "", "","", "targetingOligo", "Ambigious"]
    var ysize = 30;
    var max=0;
    
    var svg = document.getElementById("SVGmut_off");
    var NS="http://www.w3.org/2000/svg";
    var svgns = "http://www.w3.org/2000/svg";
    var strokew = "0.5";

    svg.addEventListener("mousedown", AlignmentMouseDown, false);
    svg.addEventListener("mousemove", AlignmentMouseMove_off, false);
    svg.addEventListener("mouseup", AlignmentMouseUp, false);
    svg.setAttributeNS(null, "onmousedown", "return false;"); //prevents marking

    while (svg.lastChild){
        svg.removeChild(svg.lastChild);
    }

    var delypos=20, delyshift=40;

    //bc, readsum:
    var SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("x", 40);
    SVGObj.setAttribute("y", ysize+delypos);
    SVGObj.setAttribute("font-size", "17");
    SVGObj.setAttribute("font-weight", "700");
    SVGObj.textContent = "OFF-TARGET ALIGNMENT SUMMARY: Gene: "+gene_list[gene_i]+"   |   File "+files[CurrentFileId_off].name;
    svg.appendChild(SVGObj);
    delypos+=10;

    delypos+=delyshift;


    var xfrom = BreakPoint-30 +Math.floor(AlignmentStartPos);
    var xto = xfrom +60;
    //wt: REFERENCES SEQ
    for (let x=xfrom; x<xto; x++){
        //draw base:
        SVGObj= document.createElementNS(NS,"text");
        SVGObj.setAttribute("y", ysize+delypos+20);
        SVGObj.setAttribute("font-size", "14");
        if (x>=RightBsPos && x<RightBsPos+rightbs.length) SVGObj.setAttribute("fill", "rgb(0,0,250)");
        else SVGObj.setAttribute("fill", N_cl);
        SVGObj.textContent = locus_list[gene_i][x];
        SVGObj.setAttribute("x", 120+12*(x-xfrom));
        SVGObj.setAttribute("text-anchor", "middle");
        svg.appendChild(SVGObj);
    }
    //sgRNA
    if (rightbs!=document.getElementsByName("RightBS")[0].value.replace(/[\s\n]+/g, '').toUpperCase()){
        locus2 = ReverseComplement(locus)
    }
    else{
        locus2 = locus
    }

    for (let x=RightBsPos; x<RightBsPos+rightbs.length; x++){
        //draw base:
        SVGObj= document.createElementNS(NS,"text");
        SVGObj.setAttribute("y", ysize+delypos);
        SVGObj.setAttribute("font-size", "14");
        SVGObj.setAttribute("fill", N_cl);
        SVGObj.textContent = locus_list[barcode][x];
        SVGObj.setAttribute("x", 120+12*(x-xfrom));
        SVGObj.setAttribute("text-anchor", "middle");
        svg.appendChild(SVGObj);
    }
    
    var imageElement = document.createElementNS(NS, "image");
    if (rightbs!=document.getElementsByName("RightBS")[0].value.replace(/[\s\n]+/g, '').toUpperCase()){
        imageElement.setAttribute("x", 95+12*(RightBsPos-xfrom )); // Set the x-coordinate of the image
    }    
    else{
        imageElement.setAttribute("x", 120+12*(RightBsPos+rightbs.length-xfrom)+2); // Set the x-coordinate of the image
    }
    imageElement.setAttribute("y", ysize + delypos -20); // Set the y-coordinate of the image
    imageElement.setAttribute("width", 20); // Set the width of the image
    imageElement.setAttribute("height", 20); // Set the height of the image
    imageElement.setAttribute("href", "crisprnano2/scissors.svg"); // Set the path to your image file
    svg.appendChild(imageElement);

    //reference:
    SVGObj= document.createElementNS(NS,"text");
    SVGObj.setAttribute("x", 5);
    SVGObj.setAttribute("y", ysize+delypos+20);
    SVGObj.setAttribute("font-size", "13");
    SVGObj.textContent += "REFERENCE 5'->3'";
    svg.appendChild(SVGObj);
    //line:
    SVGObj= document.createElementNS(NS,"path");
    SVGObj.setAttributeNS(null, "d", "M 5,"+(ysize+delypos+5.5)+" L 1200,"+(ysize+delypos+5.5));
    SVGObj.style.stroke=N_cl;
    SVGObj.setAttributeNS(null, "stroke-width", 1);
    svg.appendChild(SVGObj);
    delypos+=delyshift;
    var id1 = 1;

    for (let key in aln_dict_fil_off[barcode]){
        //aggregate WT
        for (let x=0; x<30*2; x++){
            //draw main track:
            if ((key[x]==locus_list[barcode][BreakPoint-region_analyse+x])||(key[x]=='N')||(key[x]=='-')||(typeof(key[x])=='undefined')){
                // SVGObj= document.createElementNS(svgns, "rect");
                // SVGObj.setAttribute("x", 120+12*(x)-5);
                // SVGObj.setAttribute("y", ysize+delypos-10);
                // SVGObj.setAttribute("width", "11");
                // SVGObj.setAttribute("height", "11");
                // SVGObj.setAttribute("fill", "rgb(255,255,255");
                // SVGObj.setAttribute("text-anchor", "middle");
                // SVGObj.setAttribute("pointer-events","none");
                // svg.appendChild(SVGObj);
                }
            }

        if (aln_type_dict_off[id][key]==1 && (Object.keys(no_indel_arr).length ==2)){
            for (let x=xfrom-10; x<xto-10; x++){
            //draw main track:
            if (Object.keys(no_indel_arr)[0][x]==Object.keys(no_indel_arr)[1][x]){
                if ((Object.keys(no_indel_arr)[0][x]==locus_list[barcode][BreakPoint-region_analyse+x])||(key[x]=='N')||(key[x]=='-')||(typeof(key[x])=='undefined')){
                }
                else {
                    SVGObj= document.createElementNS(svgns, "rect");
                    SVGObj.style.stroke=N_cl;
                    SVGObj.setAttribute("x", 115+12*(x-xfrom+10));
                    SVGObj.setAttribute("y", ysize+delypos-10);
                    SVGObj.setAttribute("width", "11");
                    SVGObj.setAttribute("height", "11");
                    SVGObj.setAttribute("fill", "rgb(255,255,255");
                    SVGObj.setAttribute("text-anchor", "middle");
                    SVGObj.setAttribute("pointer-events","none");
                    svg.appendChild(SVGObj);
                }
                SVGObj= document.createElementNS(NS, "text");
                    SVGObj.setAttribute("y", ysize+delypos);
                    SVGObj.setAttribute("font-size", "13");
                    SVGObj.setAttribute("font-weight", "400");
                    if (key[x]=="T"){SVGObj.textContent = key[x];
                        SVGObj.setAttribute("fill", T_cl);
                    }
                    else if (key[x]=="A"){SVGObj.textContent = key[x];
                        SVGObj.setAttribute("fill", A_cl);
                    }
                    else if (key[x]=="C"){SVGObj.textContent = key[x];
                        SVGObj.setAttribute("fill", C_cl);
                    }
                    else if (key[x]=="G"){SVGObj.textContent = key[x];
                        SVGObj.setAttribute("fill", G_cl);
                    }
                    else if (key[x]=="N"){SVGObj.textContent = key[x];
                        SVGObj.setAttribute("fill", N_cl);
                    }
                    else if (key[x]=="-"){SVGObj.textContent = key[x];
                        SVGObj.setAttribute("fill", N_cl);
                    }
                    SVGObj.setAttribute("x", 120+12*(x-xfrom+10));
                    SVGObj.setAttribute("text-anchor", "middle");
                    SVGObj.setAttribute("pointer-events","none");
                    svg.appendChild(SVGObj);
            }
            else {
                var fontsize1 = 2+ Math.floor(13*no_indel_arr[Object.keys(no_indel_arr)[0]]/(no_indel_arr[Object.keys(no_indel_arr)[0]]+no_indel_arr[Object.keys(no_indel_arr)[1]]))
                var fontsize2 = 2+ Math.floor(13*no_indel_arr[Object.keys(no_indel_arr)[1]]/(no_indel_arr[Object.keys(no_indel_arr)[0]]+no_indel_arr[Object.keys(no_indel_arr)[1]]))

                SVGObj= document.createElementNS(NS, "text");
                SVGObj.setAttribute("y", ysize+delypos+fontsize1-5);
                SVGObj.setAttribute("font-size", fontsize1);
                SVGObj.setAttribute("font-weight", "600");

                if (Object.keys(no_indel_arr)[0][x]=="T"){SVGObj.setAttribute("fill", T_cl);
                }
                else if (Object.keys(no_indel_arr)[0][x]=="A"){SVGObj.setAttribute("fill", A_cl);
                }
                else if (Object.keys(no_indel_arr)[0][x]=="C"){SVGObj.setAttribute("fill", C_cl);
                }
                else if (Object.keys(no_indel_arr)[0][x]=="G"){SVGObj.setAttribute("fill", G_cl);
                }
                else if (Object.keys(no_indel_arr)[0][x]=="N"){SVGObj.setAttribute("fill", N_cl);
                }
                else if (Object.keys(no_indel_arr)[0][x]=="-"){SVGObj.setAttribute("fill", N_cl);
                }
                SVGObj.textContent = Object.keys(no_indel_arr)[0][x];
                SVGObj.setAttribute("x", 120+12*(x-xfrom+10));
                SVGObj.setAttribute("text-anchor", "middle");
                SVGObj.setAttribute("pointer-events","none");
                svg.appendChild(SVGObj);

                SVGObj= document.createElementNS(NS, "text");
                SVGObj.setAttribute("y", ysize+delypos+15);
                SVGObj.setAttribute("font-size", 8);
                SVGObj.setAttribute("font-weight", "400");
                SVGObj.textContent = no_indel_arr[Object.keys(no_indel_arr)[1]] + " "+Object.keys(no_indel_arr)[1][x]
                SVGObj.setAttribute("x", 120+12*(x-xfrom+10));
                SVGObj.setAttribute("text-anchor", "middle");
                SVGObj.setAttribute("pointer-events","none");
                svg.appendChild(SVGObj);

                SVGObj= document.createElementNS(NS, "text");
                SVGObj.setAttribute("y", ysize+delypos+25);
                SVGObj.setAttribute("font-size", 8);
                SVGObj.setAttribute("font-weight", "400");
                SVGObj.textContent = no_indel_arr[Object.keys(no_indel_arr)[0]] + " " +Object.keys(no_indel_arr)[0][x]
                SVGObj.setAttribute("x", 120+12*(x-xfrom+10));
                SVGObj.setAttribute("text-anchor", "middle");
                SVGObj.setAttribute("pointer-events","none");
                svg.appendChild(SVGObj);

                SVGObj= document.createElementNS(NS, "text");
                SVGObj.setAttribute("y", ysize+delypos-5);
                SVGObj.setAttribute("font-size", fontsize2);
                SVGObj.setAttribute("font-weight", "600");

                if (Object.keys(no_indel_arr)[1][x]=="T"){SVGObj.setAttribute("fill", T_cl);
                }
                else if (Object.keys(no_indel_arr)[1][x]=="A"){SVGObj.setAttribute("fill", A_cl);
                }
                else if (Object.keys(no_indel_arr)[1][x]=="C"){SVGObj.setAttribute("fill", C_cl);
                }
                else if (Object.keys(no_indel_arr)[1][x]=="G"){SVGObj.setAttribute("fill", G_cl);
                }
                else if (Object.keys(no_indel_arr)[1][x]=="N"){SVGObj.setAttribute("fill", N_cl);
                }
                else if (Object.keys(no_indel_arr)[1][x]=="-"){SVGObj.setAttribute("fill", N_cl);
                }
                SVGObj.textContent = Object.keys(no_indel_arr)[1][x];
                SVGObj.setAttribute("x", 120+12*(x-xfrom+10));
                SVGObj.setAttribute("text-anchor", "middle");
                SVGObj.setAttribute("pointer-events","none");
                svg.appendChild(SVGObj);
            }
        }
        }
        else {
            for (let x=xfrom-10; x<xto-10; x++){
            //draw main track:
            if ((key[x]==locus_list[barcode][BreakPoint-region_analyse+x])||(key[x]=='N')||(key[x]=='-')||(typeof(key[x])=='undefined')){
                SVGObj= document.createElementNS(NS, "text");
                SVGObj.setAttribute("font-weight", "400");
            }
            else {
                SVGObj= document.createElementNS(svgns, "rect");
                SVGObj.style.stroke=N_cl;
                SVGObj.setAttribute("x", 115+12*(x-xfrom+10));
                SVGObj.setAttribute("y", ysize+delypos-10);
                SVGObj.setAttribute("width", "11");
                SVGObj.setAttribute("height", "11");
                SVGObj.setAttribute("fill", "rgb(255,255,255");
                SVGObj.setAttribute("text-anchor", "middle");
                SVGObj.setAttribute("pointer-events","none");
                svg.appendChild(SVGObj);
                SVGObj= document.createElementNS(NS, "text");
                SVGObj.setAttribute("font-weight", "600");

            }
            
            SVGObj.setAttribute("y", ysize+delypos);
            SVGObj.setAttribute("font-size", "13");

            if (key[x]=="T"){SVGObj.textContent = key[x];
                SVGObj.setAttribute("fill", T_cl);
            }
            else if (key[x]=="A"){SVGObj.textContent = key[x];
                SVGObj.setAttribute("fill", A_cl);
            }
            else if (key[x]=="C"){SVGObj.textContent = key[x];
                SVGObj.setAttribute("fill", C_cl);
            }
            else if (key[x]=="G"){SVGObj.textContent = key[x];
                SVGObj.setAttribute("fill", G_cl);
            }
            else if (key[x]=="N"){SVGObj.textContent = key[x];
                SVGObj.setAttribute("fill", N_cl);
            }
            else if (key[x]=="-"){SVGObj.textContent = key[x];
                SVGObj.setAttribute("fill", N_cl);
            }
            SVGObj.setAttribute("x", 120+12*(x-xfrom+10));
            SVGObj.setAttribute("text-anchor", "middle");
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj); 
            }
        }
        
        var image_loc = 0;
        for (let x=xfrom-10; x<xto-10; x++){
            if (x>0){
            //draw insert:
            SVGObj= document.createElementNS(svgns, "rect");
            // if ((key[x+region_analyse*2]!="\xa0")&&(key[x+region_analyse*2]!="\n")){
            if ('ACTG'.includes(key[x+region_analyse*2])){
                if (image_loc == 0){
                    var imageElement = document.createElementNS(NS, "image");
                    imageElement.setAttribute("x", 120+12*(x-xfrom+10)-16); // Set the x-coordinate of the image
                        
                    imageElement.setAttribute("y", ysize+delypos+4); // Set the y-coordinate of the image
                    imageElement.setAttribute("width", 12); // Set the width of the image
                    imageElement.setAttribute("height", 12); // Set the height of the image
                    imageElement.setAttribute("href", "crisprnano2/insert.svg"); // Set the path to your image file
                    svg.appendChild(imageElement);
                    image_loc =1;
                }
                SVGObj.style.stroke=T_cl;
                SVGObj.setAttribute("x", 120+12*(x-xfrom+10));
                SVGObj.setAttribute("y", ysize+delypos+4);
                SVGObj.setAttribute("width", "12");
                SVGObj.setAttribute("height", "12");
                SVGObj.setAttribute("fill", "rgb(255,255,255");
                SVGObj.setAttribute("text-anchor", "middle");
                SVGObj.setAttribute("pointer-events","none");
                svg.appendChild(SVGObj);
            }

            SVGObj= document.createElementNS(NS,"text");
            SVGObj.setAttribute("x", 120+12*(x-xfrom+10)+5);
            SVGObj.setAttribute("y", ysize+delypos+15);
            SVGObj.setAttribute("font-size", "13");
            SVGObj.setAttribute("fill", N_cl);
            SVGObj.textContent = key[x+region_analyse*2];
            SVGObj.setAttribute("text-anchor", "middle");
            SVGObj.setAttribute("pointer-events","none");
            svg.appendChild(SVGObj);
            }
        }
        
        SVGObj= document.createElementNS(NS,"text");
        SVGObj.setAttribute("x", 5);
        SVGObj.setAttribute("y", ysize+delypos);
        SVGObj.setAttribute("font-size", "14");
        SVGObj.textContent += "GROUP " +id1;
        svg.appendChild(SVGObj);

        SVGObj= document.createElementNS(NS,"text");
        SVGObj.setAttribute("x", 10+ 120+24*(30)+2 );
        SVGObj.setAttribute("y", ysize+delypos);
        SVGObj.setAttribute("font-size", "14");
        // Count INDEL's length
        var gap_len1 = (key.substring(region_analyse*2 +1, region_analyse*4).split("G").length-1) +(key.substring(region_analyse*2 +1, region_analyse*4).split("A").length-1) +(key.substring(region_analyse*2 +1, region_analyse*4).split("T").length-1) +(key.substring(region_analyse*2 +1, region_analyse*4).split("C").length-1) - (key.split("-").length-1);

        SVGObj.textContent +="TYPE: "+ aln_type[aln_type_dict_off[barcode][key]] + ", (" + gap_len1 + " bp)" +" | " +aln_dict_fil_off[barcode][key] +"  Reads, " + (aln_dict_fil_off[barcode][key]/summary_track_off[barcode][7]*100).toFixed(2) + " %";
        svg.appendChild(SVGObj);
        id1+=1;
        delypos+=delyshift;
    }
     AlignmentPrecalc_off[gene_i] = document.getElementById("DIV_alignment_off").innerHTML;
}


function SaveReport() {
    //alert(svg.innerHTML);
    const workbook = XLSX.utils.book_new();
    const worksheet = XLSX.utils.aoa_to_sheet(summary_track_select);
    XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");
    const excelBuffer = XLSX.write(workbook, { type: "array", bookType: "xlsx" });
    const bb = new Blob([excelBuffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });

    // var bb = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    var a = document.createElement('a');
    a.download = document.getElementsByName("GeneName")[0].value+".xlsx";
    a.href = window.URL.createObjectURL(bb);
    a.textContent = 'Click here to save';
    a.dataset.downloadurl = ['text/plain', a.download, a.href].join(':');
    document.getElementById("save").appendChild(a);
    a.click();
}

function SaveReportcsv() {
    //alert(svg.innerHTML);
    const csvContent = summary_track_select.map(row => row.join("\t")).join("\n");
 
    var bb = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    var a = document.createElement('a');
    a.download = document.getElementsByName("GeneName")[0].value+".csv";
    a.href = window.URL.createObjectURL(bb);
    a.textContent = 'Click here to save';
    a.dataset.downloadurl = ['text/plain', a.download, a.href].join(':');
    document.getElementById("save").appendChild(a);
    a.click();
}

function SaveSVGAlignment()
{
    var svg = document.getElementById("DIV_alignment");
    var svgContent = svg.innerHTML.replace(/&nbsp;/g, ' ');
    var bb = new Blob([svgContent], {type: 'text/plain'});
    var a = document.createElement('a');
    a.download = document.getElementsByName("GeneName")[0].value+" "+GetWellPos(CurrentAlignment)+".svg";
    a.href = window.URL.createObjectURL(bb);
    a.textContent = 'Click here to save';
    a.dataset.downloadurl = ['text/plain', a.download, a.href].join(':');
    document.getElementById("save").appendChild(a);
    a.click();
}

function PrintSVG()
{
    var printWindow = document.open('', 'Print', 'width=900, height=550');
    printWindow.document.writeln(document.getElementById("DIV_piecharts").innerHTML);
    printWindow.document.close();
    printWindow.print();
    printWindow.close();
}

function ReverseString(str) {
        return str.split('').reverse().join('')
    }

function PrintSVGAlignment(){
    var printWindow = document.open('', 'Print', 'width=1250, height=400');
    printWindow.document.writeln(document.getElementById("DIV_alignment").innerHTML);
    printWindow.document.close();
    printWindow.print();
    printWindow.close();
}


// Check micro homology for given sequence 
// input: our alignment dictionary element does not contain insertion track

function Check_RIMA(sequence_seq){
    var micro_homology = ''
    const startIndex = sequence_seq.indexOf('-');
    const endIndex = sequence_seq.lastIndexOf('-') + 1;
    const insert_size = sequence_seq.split('\n')[1].trim().length
    var ref_seq = locus.substring(10, sequence_seq.length + 10)
    if (startIndex !=0){
        for (let i = startIndex; i < endIndex; i++) {
            if (ref_seq[i]==sequence_seq[i+endIndex-startIndex]){
                micro_homology+=ref_seq[i]
            }
            else{
                break
            }
        }
    }
    return [micro_homology, startIndex, endIndex, insert_size];   
}


// Check duplication for insertion sequence 
// input: our alignment dictionary element contains insertion track
function Check_duplication(sequence_seq){
    var duplicate = false
    const main_track = sequence_seq.split('\n')[0]
    const insertion = sequence_seq.split('\n')[1]
    const insertion_trim = insertion.trim()
    var index_in = 0
    if (insertion_trim !=''){
        index_in = insertion.indexOf(insertion_trim)
        duplicate = (main_track.substring(index_in, index_in+insertion_trim.length)==insertion.substring(index_in, index_in+insertion_trim.length)||main_track.substring(index_in-insertion_trim.length, index_in)==insertion.substring(index_in, index_in+insertion_trim.length))
    }
    return [duplicate, index_in, insertion_trim.length];   
}


// For google site
function myFunction1() {
    var popup = document.getElementById("help1");
    popup.classList.toggle("show");
}
function myFunction2() {
    var popup = document.getElementById("help2");
    popup.classList.toggle("show");
}
function myFunction3() {
    var popup = document.getElementById("help3");
    popup.classList.toggle("show");
}
function myFunction4() {
    var popup = document.getElementById("help4");
    popup.classList.toggle("show");
}
function myFunction5() {
    var popup = document.getElementById("help5");
    popup.classList.toggle("show");
}

function myFunction7() {
    var popup = document.getElementById("help7");
    popup.classList.toggle("show");
}
function myFunction8() {
    var popup = document.getElementById("help8");
    popup.classList.toggle("show");
}
function myFunction9() {
    var popup = document.getElementById("help9");
    popup.classList.toggle("show");
}

function myFunction10() {
    var popup = document.getElementById("help10");
    popup.classList.toggle("show");
}

function Start(){
    document.getElementById("progress").style.display = '';
    //Reset all variables
    for (var i=0; i<96; i++) {
        phred_array[i] = []
        length_array[i] = []
        aln_dict[i] = {}
        aln_dict_fil[i] = {}
        gcContent[i] = []
    }
    AlignmentPrecalc = new Array(96);
    for (var i=0; i<96; i++){
        sum_track[i] = 0;
        summary_track[i] = Array(8); 
    }

    if (locus == ''){
        locus = document.getElementsByName("Locus")[0].value.replace(/[\s\n]+/g, '').toUpperCase(); //reference sequence
    }
    rightbs = document.getElementsByName("RightBS")[0].value.replace(/[\s\n]+/g, '').toUpperCase(); // sgRNA seq  
    
    MutationThreshold = document.getElementsByName("MutationThreshold")[0].value;
    region_analyse = document.getElementsByName("region_analyse")[0].value;

    //Find Target site in the reference sequence/locus:
    if (rightbs.length == 0){
        alert("No target site was entered. Please enter a valid sequence");
        return;
    }
    if (locus.includes(rightbs)){
        RightBsPos = locus.search(rightbs);
    }
    else if (locus.includes(ReverseComplement(rightbs))){
        rightbs = ReverseComplement(rightbs);
        RightBsPos = locus.search(rightbs);
    }
    else if (locus.includes(ReverseString(rightbs))){
        rightbs = ReverseString(rightbs);
        RightBsPos = locus.search(rightbs);
    }
    else if (locus.includes(ReverseString(ReverseComplement(rightbs)))){
        rightbs = ReverseString(ReverseComplement(rightbs));
        RightBsPos = locus.search(rightbs);
    }
    else {
        alert("The target site was not found in the reference sequence. Please enter a valid sequence");
        document.getElementById("progress").style.display = 'Please check the input form';
        return
    }
    
    //check other field 
    if (region_analyse*1>80){
        alert('Please reduce the region analyse value');
        return
    }
    
    //Update new locus, and sgRNA position 
    locus_check = locus.substring(RightBsPos -region_analyse*1-10, RightBsPos -region_analyse*1)
    locus = locus.substring(RightBsPos -region_analyse*1, RightBsPos + 20 +region_analyse*1)
    //add new roi for adaptive aligning
    for (let i=0; i<1; i++){
        roi.push(locus.substring(i, i+20));
        roi.push(ReverseComplement(locus.substring(i, i+20)));
    }
    RightBsPos = locus.search(rightbs);
    //breaking point on locus 
    if (rightbs!=rightbs != document.getElementsByName("RightBS")[0].value.replace(/[\s\n]+/g, '').toUpperCase()){
        BreakPoint = RightBsPos + 20 -10;
    }
    else{
        BreakPoint = RightBsPos + 20 
    }
    
    var evt = document.getElementById('files');
    files = evt.files;

    if (files.length <= 0) {
        alert("No files were specified. Please upload your fastq files");
        return;
    }
    
    CurrentFileId = 0;
    CurrentFileChunk = 0;
    ReadNextFileChunk();

}

function Start2(){
    document.getElementById("progress1").style.display = '';
    gene_list = document.getElementsByName("GeneName_list")[0].value.split(',')
    rightbs = document.getElementsByName("RightBS")[0].value.replace(/[\s\n]+/g, '').toUpperCase(); // sgRNA seq
    region_analyse = document.getElementsByName("region_analyse")[0].value;

    //reset all varibles
    for (var i=0; i<4; i++){
        sum_track_off[i] = 0;
        summary_track_off[i] = Array(8); 
    }
    AlignmentPrecalc_off = new Array(4);
    for (var i=0; i<4; i++) {
        hits_off[i] = []
        aln_dict_off[i] = {}
        aln_dict_fil_off[i] = {}
        aln_type_dict_off[i] = {}
    }

    //Score of OFF target reference
    var ms = 1 // match score
    var mms = -1 //mismatch score
    var gapo = -2  // gap open score
    var gape = -1  // gap extent score

    //Find Target site in the reference sequence/locus:
    if (rightbs.length == 0){
        alert("No target site was entered. Please enter a valid sequence");
        return;
    }

    for (let i = 0; i<locus_list.length; i++){
        var rst = bsa_align(locus_list[i], rightbs, [ms, mms], [gapo, gape]);
        if (rst[0]<(rightbs.length/2)){
            rst = bsa_align(ReverseComplement(locus_list[i]), rightbs, [ms, mms], [gapo, gape]);
            if (rst[0]<(rightbs.length/2)){
                alert("The target site was not found in the given OFF-TARGET reference gene ("+ gene_list[i] +"). Please enter a valid gene name");
            }
            else {
            RightBsPos_off[i] = rst[1];
            locus_list1[i] = ReverseComplement(locus_list[i]).substring(RightBsPos_off[i] -region_analyse*1-30, RightBsPos_off[i] -region_analyse*1)
            locus_list[i] = ReverseComplement(locus_list[i]).substring(RightBsPos_off[i] -region_analyse*1, RightBsPos_off[i] + rightbs.length +region_analyse*1)
            }
        }   
        else {
            RightBsPos_off[i] = rst[1];
            locus_list1[i] = locus_list[i].substring(RightBsPos_off[i] -region_analyse*1-30, RightBsPos_off[i] -region_analyse*1)
            locus_list[i] = locus_list[i].substring(RightBsPos_off[i] -region_analyse*1, RightBsPos_off[i] + 20 +region_analyse*1)
        }
        //Update new index
        var rst = bsa_align(locus_list[i], rightbs, [ms, mms], [gapo, gape]);
        if (rst[0]<(rightbs.length-3)){
            rst = bsa_align(ReverseComplement(locus_list[i]), rightbs, [ms, mms], [gapo, gape]);
            if (rst[0]<(rightbs.length-3)){
                RightBsPos_off[i] = rst[1];
            }
        }   
        else {
            RightBsPos_off[i] = rst[1];
            BreakPoint_off[i] = RightBsPos_off[i] + 20
        }
    }    
    CurrentFileId_off = CurrentAlignment;
    CurrentFileChunk = 0;
    ReadNextFileChunk_off();
}

function containsAny(string, array) {
  return array.every(item => string.includes(item));
}

var bst_nt5 = [
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,
    4, 0, 4, 1,  4, 4, 4, 2,  4, 4, 4, 4,  4, 4, 4, 4,
    4, 4, 4, 4,  3, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,
    4, 0, 4, 1,  4, 4, 4, 2,  4, 4, 4, 4,  4, 4, 4, 4,
    4, 4, 4, 4,  3, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,
    4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4,  4, 4, 4, 4
];


function binQualityScores(qualityScores, resolution) {
            const bins = new Array(Math.ceil(40 / resolution)).fill(0);
            for (let score of qualityScores) {
                const binIndex = Math.floor(score / resolution);
                bins[binIndex]++;
            }
            return bins;
        }

function calculateGCContent(sequence) {
    let gcCount = 0;
    for (let i = 0; i < sequence.length; i++) {
        if (sequence[i] === 'G' || sequence[i] === 'C') {
            gcCount++;
        }
    }
    return (gcCount / sequence.length) * 100;
}

function divide_zero(a, b) {
    if (b === 0) {
        return 0;
    } else {
        return a / b;
    }
}

var currenttab = 0;
TabClicked(0);

var RightBsPos=0;
//raw aligned dictionary
var aln_dict = Array(96);
//filtered aligned dictionary
var aln_dict_fil = Array(96)

var AlignmentPrecalc
var locus = '';
var locus_check = ''; //adaptive ref
var files;
var reader;
var CurrentFileId;
var CurrentFileId_off;
var MutationThreshold = 0.1
var BreakPoint;
var rightbs;

var PhredThreshold = 40; // 7 +33

var sum_track = Array(96)
var summary_track = Array(96)
var summary_track_select = Array(97)
summary_track_select[0] = ["Sample", "%Oligo (KI)", "% WT", "% In-frame", "% Out-frame", "# Total Aligned Read"]
var phred_array = Array(96)
var length_array = Array(96)

var region_analyse =30;

var roi = []

// Offtarget analyzer
var CurrentAlignment_off = 0;
var CurrentAlignment = 0;

var AlignmentPrecalc_off = new Array(4);
var AlignmentPrecalc_bulk
var locus_list = [];
var locus_list1 = []; // gene unique regions

var BreakPoint_off = [];
var sum_track_off = Array(4)
var summary_track_off = Array(4)

var hits_off = Array(4);
//raw aligned dictionary
var aln_dict_off = Array(4);
//filtered aligned dictionary
var aln_dict_fil_off = Array(4)
var aln_type_dict_off = Array(4)

var RightBsPos_off = [0, 0, 0, 0];
var BreakPoint_off = [0, 0, 0, 0]
var sum_track_off = Array(4)

var RestFromLastChunk = "";
var chunksize = 1024*1024;
var gene_id = 0;
var gene_list = ''
var genotype = Array(96)
var aln_dict_bulk 
var gcContent = Array(96)
var bulk_threshold = 0.1

var no_indel = Array(96) 
var no_indel_arr = Array(96)
var inf_indel =  Array(96)
var out_indel = Array(96)
var out_indel_arr = Array(96)
var sum = Array(96)
var targetingOligo = Array(96)
var targetingOligo_arr = Array(96)

const T_cl = "rgb(255,0,0)"
const A_cl = "rgb(0,150,0)"
const C_cl ="rgb(0,0,255)"
const G_cl = "rgb(200, 100, 0)"
const N_cl = "rgb(0, 0, 0)"

const toggleButton = document.getElementById('toggleButton');
const sgRNAContainer = document.getElementById('sgRNAContainer');
const optional_para = document.getElementById('optional_para');
const optional_para_Container = document.getElementById('optional_para_Container');

toggleButton.addEventListener('click', function() {
    sgRNAContainer.classList.toggle('hidden');
});

optional_para.addEventListener('click', function() {
    optional_para_Container.classList.toggle('hidden');
});


</script>
</html>